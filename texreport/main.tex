\documentclass[a4paper,english]{lipics-utf8x}

\usepackage[T1]{fontenc} %

\usepackage{amsmath, amssymb, amsfonts, stmaryrd}
\usepackage{pifont}
\PrerenderUnicode{é} % For the author names in the heading

% Add some colors
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{hyperref}
\hypersetup{
 linktocpage,
 colorlinks,
 citecolor=BlueViolet,
 filecolor=red,
 linkcolor=Blue,
 urlcolor=BrickRed
}

\usepackage{graphicx}
\usepackage{placeins}

% Meta comment
\newcommand\meta[1]{\noindent\textcolor{blue}{\emph{#1}}}

% Include the macro file
\input{macros}

% Title and so...
\title{Trust me I'm a an hProp}
\author[1]{Théo Winterhalter}

\begin{document}

  \maketitle

  \begin{abstract}
    This is an attempt to add one resizing rule that would subsume several of
    them, including the equivalence and the hProp ones.
  \end{abstract}

  \section{Syntax}

  \[
    \begin{array}{l@{~}l@{~}l@{~}r@{~}l@{\quad}l}
      \Var  & \ni & x,y,X,Y \\
      \Sort & \ni & s             & ::= & \Type_k \mbox{ }
                                                (k \in \mathbb{N}) \\
      \Exp  & \ni & t,u,T,U & ::= & s \mid \Pi x:U.T \mid \Sigma x:U.T \mid
                                    t =_T u \mid \RRe{U}{T}{h} \\
                         &&& \mid & x \mid \lambda x:U.t \mid t~u
                               \mid (t;u) \mid t.1 \mid t.2 \mid \refl_t \\
      \Ctx  & \ni & \Gamma  & ::= & \cdot \mid \Gamma, x:T \\
    \end{array}
  \]

  \noindent %
  We write $A \to B$ as short for $\Pi \_:A.B$, the non-dependent product.
  We also write $=$ for $=_T$ when $T$ is understood.
  %
  The notation $\emb{A}{B}$ denotes the type of embeddings of $A$ into $B$.
  \[
    \begin{array}{l@{\quad}l@{~}l@{~}l}
      & \emb{A}{B} &:=& \Sigma (f : A \to B). \isEquiv \ap_f \\
      \text{where} & \ap_f &:& (x =_A y) \to (f(x) =_B f(y)) \\
      \text{and} & \isEquiv f &:=& \Sigma_{(g : B \to A)}
                               \Sigma_{(\eta : g \circ f \sim \id_A)}
                               \Sigma_{(\varepsilon : f \circ g \sim \id_B)}
                               \Pi_{(x : A)} f~(\eta~x) = \varepsilon~(f~x) \\
      \text{and} & h_1 \sim h_2 &:=& \Pi_{(x : T)} h_1~x = h_2~x.
    \end{array}
  \]

  \section{Typing Rules}

  \begin{center}
  \(
    \ru{}{\der \cdot}
    \qquad
    \ru{\Gamma \der T : s \qquad
        x \notin \Gamma
      }{\der \Gamma, x : T}
    \qquad
    \ru{\der \Gamma
      }{\Gamma \der \Type_i : \Type_{i+1}}
    \qquad
    \ru{\der \Gamma \qquad
        (x : T) \in \Gamma
      }{\Gamma \der x : T}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : \Pi x:A.B \qquad
        \Gamma \der t' : A
      }{\Gamma \der t\ t' : B[t'/x]}
    \qquad
    \ru{\Gamma \der A : s \qquad
        \Gamma, x:A \der B : s' \qquad
        (s,s',s'') \in \R
      }{\Gamma \der \Pi x:A.B : s''}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der \Pi x:A.B : s \qquad
        \Gamma, x:A \der t : B
      }{\Gamma \der \lambda x:A.t : \Pi x:A.B}
    \qquad
    \ru{\Gamma \der t : \Sigma x:A.B
      }{\Gamma \der t.1 : A}
    \qquad
    \ru{\Gamma \der t : \Sigma x:A.B
      }{\Gamma \der t.2 : B[t.1/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der A : s \qquad
        \Gamma, x:A \der B : s' \qquad
        (s,s',s'') \in \R
      }{\Gamma \der \Sigma x:A.B : s''}
    \qquad
    \ru{\Gamma \der T : s \qquad
        \Gamma \der t,t' : T
      }{\Gamma \der t =_T t' : s}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : A \qquad
        \Gamma \der t' : B[t/x] \qquad
        \Gamma \der \Sigma x:A.B : s
      }{\Gamma \der (t;t') : \Sigma x:A.B}
    \qquad
    \ru{\Gamma \der t : T
      }{\Gamma \der \refl_t : t =_T t}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : A \qquad
        \Gamma \der B : s \qquad
        \Gamma \der A \le B
      }{\Gamma \der t : B}
  \)
  \end{center}

  \noindent %
  Rules regarding resized types mirror those for the type they are
  \emph{hiding}.

  \begin{center}
  \(
    \ru{\Gamma \der A : \Type_i \qquad
        \Gamma \der B : \Type_j \qquad
        \Gamma \der h : \emb{A}{B}
      }{\Gamma \der \RRe{A}{B}{h} : \Type_j}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : \RRe{(\Pi x:A.B)}{C}{h} \qquad
        \Gamma \der t' : A
      }{\Gamma \der t\ t' : B[t'/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der \RRe{(\Pi x:A.B)}{C}{h} : s \qquad
        \Gamma, x:A \der t : B
      }{\Gamma \der \lambda x:A.t : \RRe{(\Pi x:A.B)}{C}{h}}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : \RRe{(\Sigma x:A.B)}{C}{h}
      }{\Gamma \der t.1 : A}
    \qquad
    \ru{\Gamma \der t : \RRe{(\Sigma x:A.B)}{C}{h}
      }{\Gamma \der t.2 : B[t.1/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : A \qquad
        \Gamma \der t' : B[t/x] \qquad
        \Gamma \der \RRe{(\Sigma x:A.B)}{C}{h} : s
      }{\Gamma \der (t;t') : \RRe{(\Sigma x:A.B)}{C}{h}}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : T \qquad
        \Gamma \der \RRe{(t =_T t)}{U}{h} : s
      }{\Gamma \der \refl_t : \RRe{(t =_T t)}{U}{h}}
  \)
  \end{center}

  \section{Equality Rules}

  \paradot{Computation ($\beta$) and extensionality ($\eta$)}

  \begin{center}
  \(
    \ru{\Gamma, x:U \der t:V \qquad
        \Gamma \der u : U
      }{\Gamma \der (\lambda x:U.t)~u = t[u/x] : V[u/x]}
    \qquad
    \ru{\Gamma \der t : \Pi x:U.V
      }{\Gamma \der t = \lambda x:U.t~x : \Pi x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : U \qquad
        \Gamma \der t' : V[t/x]
      }{\Gamma \der (t;t').1 = t : U}
    \qquad
    \ru{\Gamma \der t : U \qquad
        \Gamma \der t' : V[t/x]
      }{\Gamma \der (t;t').2 = t' : V[t/x]}
  \)
  \end{center}

  \paradot{Equivalence Rules}

  \begin{center}
  \(
    \ru{\Gamma \der t : T
      }{\Gamma \der t = t : T}
    \qquad
    \ru{\Gamma \der t' = t : T
      }{\Gamma \der t = t' : T}
    \qquad
    \ru{\Gamma \der t_1 = t_2 : T \qquad
        \Gamma \der t_2 = t_3 : T
      }{\Gamma \der t_1 = t_3 : T}
  \)
  \end{center}

  \paradot{Compatibility Rules}

  \begin{center}
  \(
    \rux{\Gamma \der U = U' : s \qquad
         \Gamma, x:U \der V = V' : s'
       }{\Gamma \der \Pi x:U.V = \Pi x:U'.V' : s''
       }{(s,s',s'') \in \R}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der U = U' : s \qquad
        \Gamma, x:U \der V : s' \qquad
        \Gamma, x:U \der t = t' : V
      }{\Gamma \der \lambda x:U.t = \lambda x:U'.t' : \Pi x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : \Pi x:U.V \qquad
        \Gamma \der u = u' : U
      }{\Gamma \der t~u = t'~u' : V[u/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{\Gamma \der U = U' : s \qquad
         \Gamma, x:U \der V = V' : s'
       }{\Gamma \der \Sigma x:U.V = \Sigma x:U'.V' : s''
       }{(s,s',s'') \in \R}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t_1 = t'_1 : U \qquad
        \Gamma, x:U \der V : s \qquad
        \Gamma \der t_2 = t'_2 : V[t_1/x]
      }{\Gamma \der (t_1;t_2) = (t'_1;t'_2) : \Sigma x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : \Sigma x:U.V
      }{\Gamma \der t.1 = t'.1 : U}
    \qquad
    \ru{\Gamma \der t = t' : \Sigma x:U.V
      }{\Gamma \der t.2 = t'.2 : V[t.1/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der T = T' \qquad
        \Gamma \der t = t' : T \qquad
        \Gamma \der u = u' : T
      }{\Gamma \der t =_T u = t' =_{T'} u'}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : T \qquad
      }{\Gamma \der \refl_t = \refl_{t'} : t =_T t}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der U = U' : s \qquad
        \Gamma \der T = T' : s' \qquad
        \Gamma \der h, h' : \emb{U}{T}
      }{\Gamma \der \RRe{U}{T}{h} = \RRe{U'}{T'}{h'} : s'}
  \)
  \end{center}

  \paradot{Conversion Rule}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : T \quad
        \Gamma \der T \le T'
      }{\Gamma \der t = t' : T'}
  \)
  \end{center}


  \section{Cumulativity}

  \begin{center}
  \(
    \rux{}{\Gamma \der \Type_i \le \Type_j}{i \le j}
    \qquad
    \ru{\Gamma \der U = U' : s \qquad
        \Gamma, x:U \der T \le T'
      }{\Gamma \der \Pi x:U.T \le \Pi x:U'.T'}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der T = T' : s
      }{\Gamma \der T \le T'}
    \qquad
    \ru{\Gamma \der T_1 \le T_2 \qquad
        \Gamma \der T_2 \le T_3
      }{\Gamma \der T_1 \le T_3}
  \)
  \end{center}

  \section{Algorithmic Equality}

  \paradot{Weak head normalization}

  Weak head normal forms (whnfs) are given by the following grammar:

  \begin{align*}
    \Whnf &\ni a,f,A,B,F &::=~& \Pi x:U.T \mid \Sigma x:U.T \mid t =_T u
                           \mid \RRe{U}{T}{t} \\
        &&\mid~& n \mid \lambda x:U.t \mid (t;u) \mid \refl_t \\
    \Wne  &\ni n,N &::=~& x \mid n~u \mid n.1 \mid n.2
  \end{align*}
  %
  We present weak-head reduction as follows:

  \begin{center}
  \(
    \ru{t \rew f \qquad
        f~u \rew a
      }{t~u \rew a}
    \qquad
    \ru{}{a \rew a}
    \qquad
    \ru{t[u/x] \rew a
      }{(\lambda x:U.t)~u \rew a}
    \qquad
    \ru{}{n~u \rew n~u}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{t \rew (u;v) \qquad
        u \rew a
      }{t.1 \rew a}
    \qquad
    \ru{t \rew (u;v) \qquad
        v \rew a
      }{t.2 \rew a}
    \qquad
    \ru{t \rew n
      }{t.1 \rew n.1}
    \qquad
    \ru{t \rew n
      }{t.2 \rew n.2}
  \)
  \end{center}
  %
  We will write $\red t$ for $a$ when $t \rew a$.

  \paradot{Type-directed Equality}

  \begin{center}
  \(
    \ru{\Gamma \der t \iff t' : \red T
      }{\Gamma \der t \hiff t' : T}
    \qquad
    \ru{\Gamma, x:U \der t~x \hiff t'~x : V
      }{\Gamma \der t \iff t' : \Pi x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t.1 \hiff t'.1 : U \qquad
        \Gamma \der t.2 \hiff t'.2 : V[t.1/x]
      }{\Gamma \der t \iff t' : \Sigma x:U.V}
  \)
  \end{center}

  \meta{We need observations for equality to define it, don't we?
  Otherwise we could just state equality for $\refl$.}

  \begin{center}
  \(
    \ru{\Gamma \der t \hiff t' : T
      }{\Gamma \der t \iff t' : \RRe{T}{U}{h}}
  \)
  \end{center}

  \paradot{Structural Equality}

  \begin{center}
  \(
    \ru{\Gamma \der n \hsteq n' : T
      }{\Gamma \der n \steq n' :\ \red T}
    \qquad
    \ru{(x:T) \in \Gamma
      }{\Gamma \der x \hsteq x : T}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der n \steq n' : \Pi x:U.V \qquad
        \Gamma \der u \hiff u' : U
      }{\Gamma \der n~u \hsteq n'~u' : V[u/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der n \steq n' : \Sigma x:U.V
      }{\Gamma \der n.1 \hsteq n'.1 : U}
    \qquad
    \ru{\Gamma \der n \steq n' : \Sigma x:U.V
      }{\Gamma \der n.2 \hsteq n'.2 : V[n.1/x]}
  \)
  \end{center}

  \paradot{Type Equality}

  \begin{center}
  \(
    \ru{\Gamma \der \red T \iff \red T'
      }{\Gamma \der T \hiff T'}
    \qquad
    \ru{\Gamma \der U \hiff U' \qquad
        \Gamma, x:U \der V \hiff V'
      }{\Gamma \der \Pi x:U.V \iff \Pi x:U'.V'}
    \qquad
    \ru{\Gamma \der N \hsteq N' : \_
      }{\Gamma \der N \iff N'}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der U \hiff U' \qquad
        \Gamma, x:U \der V \hiff V'
      }{\Gamma \der \Sigma x:U.V \iff \Sigma x:U'.V'}
    \qquad
    \ru{\Gamma \der U \hiff U' \qquad
        \Gamma \der T \hiff T'
      }{\Gamma \der \RRe{U}{T}{h} \iff \RRe{U'}{T'}{h'}}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der T \hiff T' \qquad
        \Gamma \der t \hiff t' : T \qquad
        \Gamma \der u \hiff u' : T
      }{\Gamma \der t =_T u \iff t' =_T u'}
  \)
  \end{center}

  \section{A Logical Relation for Soundness}

  \paradot{An Induction Measure}

  In order to define a logical relation, we define semantic universe hierarchy.
  By recursion on $i \in \mathbb{N}$, we define
  $\U_i \in \Whnf \times \mathcal{P}(\Whnf)$ as follows.

  \begin{center}
  \(
    \ru{}{(N, \Wne) \in \U_i}
    \qquad
    \rux{}{(\Type_i, \mid \U_i \mid) \in \U_j}{(\Type_i,\Type_j) \in \Ax}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{(U, \mathcal{A}) \in \widehat{U_i} \qquad
         \forall u \in \widehat{\mathcal{A}}.\ (T[u/x],\mathcal{F}(u)) \in
         \widehat{\U_j}
       }{(\Pi x:U.T, \Pi \mathcal{A} \mathcal{F}) \in \U_k
       }{(\Type_i, \Type_j, \Type_k) \in \R}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{(U, \mathcal{A}) \in \widehat{\U_i} \qquad
        \forall u \in \widehat{\mathcal{A}},\ (V[u/x], \mathcal{F}(u)) \in
        \widehat{\U_j}
       }{(\Sigma x:U.V, \Sigma \mathcal{A} \mathcal{F}) \in \U_k
       }{(\Type_i, \Type_j, \Type_k) \in \R}
  \)
  \end{center}

  \meta{Here we also need to find a way to observe equalities to interperet
  the equaity type...}

  \begin{center}
  \(
    \ru{(U, \mathcal{A}) \in \widehat{\U_i}
      }{(\RRe{T}{U}{h}, \RRcal{\mathcal{A}}{h})}
  \)
  \end{center}

  \noindent %
  Here, $\mathcal{A}$ denotes sets of expressions, $\mathcal{F}$ functions from
  expressions to set of expressions while
  $\widehat{\U_i} = \{ (T,\mathcal{A}) \mid (\red T, \mathcal{A}) \in \U_i \}$
  and $\mid \U_i \mid = \{ A \mid (A, \mathcal{A}) \in \U_i \text{ for some }
  \mathcal{A} \}$.
  $\widehat{\mathcal{A}} = \{ t \mid \red t \in \mathcal{A} \}$ is the closure
  of $\mathcal{A}$ by weak head expansion.
  The dependent function space is defined as
  $\Pi \mathcal{A} \mathcal{F} = \{ f \in \Whnf \mid \forall u \in
  \widehat{\mathcal{A}},\ f~u \in \mathcal{F}(u) \}$.
  The dependent sum space is defined as
  $\Sigma \mathcal{A} \mathcal{F} = \{ f \in \Whnf \mid f.1 \in
  \widehat{\mathcal{A}} \text{ and } f.2 \in \mathcal{F}(f.1) \}$.
  The resized space derived from an embedding is defined as
  $\RRcal{\mathcal{A}}{h} = \{ f \in \Whnf \mid h.1~f \in \widehat{\mathcal{A}}
  \}$ (note that intuitively, this corresponds to the interpretation of $T$
  which we can't mention yet for universe stratification reasons).

  Throughout this paper, the induction measure $A \in \Type_i$ shall mean the
  minimum height of a derivation of $(A, \mathcal{A}) \in \U_i$ for some
  $\mathcal{A}$. Note that we also have that $A \in \Type_i$ is smaller
  than $\Type_i \in \Type_j$.
  We also write $A \in s$ for $A \in \Type_i$ for some $i$.

  \paradot{A Kripke Logical Relation}

  Let $\Gamma \der t :=: t' : T$ stand for the conjunction of propositions
  \begin{itemize}
    \item $\Gamma \der t,t' : T$ and
    \item $\Gamma \der t = t' : T$.
  \end{itemize}
  %
  By induction on $A \in s$, we define two Kripke relations:
  \begin{itemize}
    \item $\Gamma \der A \Sr A' : s$
    \item $\Gamma \der a \Sr a' : A$
  \end{itemize}
  together with their respective closures $\hSr$.
  We define them in rule form for better readability meaning we have to see the
  conclusion to be defined as the conjunction of the premises.

  \begin{center}
  \(
    \ru{\Gamma \der N :=: N'
      }{\Gamma \der N \Sr N'}
    \qquad
    \ru{\Gamma \der n :=: n' : N
      }{\Gamma \der n \Sr n' : N}
    \qquad
    \rux{\der \Gamma
       }{\Gamma \der s \Sr s : s'
       }{(s,s')}
  \)
  \end{center}

  \begin{center}
  \(
    \trux{\Gamma \der U \hSr U' : s
        }{\forall \Delta \le \Gamma,\ \Delta \der u \hSr u' : U \gives
          \Delta \der V[u/x] \hSr V'[u'/x] : s'
        }{\Gamma \der \Pi x:U.V :=: \Pi x:U'.V' : s''
        }{\Gamma \der \Pi x:U.V \Sr \Pi x:U'.V' : s''
        }{(s,s',s'')}
  \)
  \end{center}

  \begin{center}
  \(
    \dru{\forall \Delta \le \Gamma,\ \Delta \der u \hSr u' : U \gives
         \Delta \der f~u \hSr f'~u' : V[u/x]
       }{\Gamma \der f :=: f' : \Pi x:U.V
       }{\Gamma \der f \Sr f' : \Pi x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \trux{\Gamma \der U \hSr U' : s
        }{\forall \Delta \le \Gamma,\ \Delta \der u \hSr u' : U \gives
          \Delta \der V[u/x] \hSr V'[u'/x] : s'
        }{\Gamma \der \Sigma x:U.V :=: \Sigma x:U'.V' : s''
        }{\Gamma \der \Sigma x:U.V \Sr \Sigma x:U'.V' : s''
        }{(s,s',s'')}
  \)
  \end{center}

  \begin{center}
  \(
    \dru{\Gamma \der f.1 \hSr f'.1 : U \qquad
         \Gamma \der f.2 \hSr f'.2 : V[f.1/x]
       }{\Gamma \der f :=: f' : \Sigma x:U.V
       }{\Gamma \der f \Sr f' : \Sigma x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \dru{\Gamma \der T \hSr T' : s \qquad
         \Gamma \der U \hSr U' : s'
       }{\Gamma \der h \hSr h : \emb{T}{U} \qquad
         \Gamma \der h' \hSr h' : \emb{T}{U}
       }{\Gamma \der \RRe{T}{U}{h} \Sr \RRe{T'}{U'}{h'} : s'}
  \)
  \end{center}

  \meta{If I'm not mistaken, this rule doesn't actually work, it would be nicer
  if we didn't need $\Gamma \der T \hSr T' : s$ to hold...}

  \begin{center}
  \(
    \dru{\Gamma \der f \hSr f' : T
       }{\Gamma \der f :=: f' : \RRe{T}{U}{h}
       }{\Gamma \der f \Sr f' : \RRe{T}{U}{h}}
  \)
  \end{center}

  \meta{This time it's the same, we can't talk about $T$ in the premises...}

  \begin{center}
  \(
    \qru{T \rew A \qquad
         \Gamma \der T = A
       }{t \rew a \qquad
         \Gamma \der t = a : A \qquad
         \Gamma \der t' = a' : A \qquad
         t' \rew a'
       }{\Gamma \der a \Sr a' : A
       }{\Gamma \der t :=: t' : T
       }{\Gamma \der t \hSr t' : T}
  \)
  \end{center}

\end{document}
