\documentclass[a4paper,english]{lipics-utf8x}

\usepackage[T1]{fontenc} %

\usepackage{amsmath, amssymb, amsfonts, stmaryrd}
\usepackage{bm}
\usepackage{pifont}
\PrerenderUnicode{é} % For the author names in the heading

% Add some colors
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{hyperref}
\hypersetup{
 linktocpage,
 colorlinks,
 citecolor=BlueViolet,
 filecolor=red,
 linkcolor=Blue,
 urlcolor=BrickRed
}

\usepackage{graphicx}
\usepackage{placeins}

% Meta comment
\newcommand\meta[1]{\noindent\textcolor{blue}{\emph{#1}}}

% Include the macro file
\input{macros}

% Title and so...
\title{Working Resizing Rules under Univalence}
\author[1]{Théo Winterhalter}

\begin{document}

  \maketitle

  \begin{abstract}
    We show how to turn an equality into a strict equivalence. This is essential
    to instrumentalize resizing rules under the assumption of univalence.
    In its globality, our main result is a proof of consistency of resizing
    rules that relies on univalence and possibly the law of excluded middle
    (depending on which resizing rules we seek). The implementation, however,
    does not require the user to assume them. In a sense, they could be weaker
    versions of the univalence axiom (and excluded middle).
  \end{abstract}

  \section{Resizing of Equality}

  \subsection{Systems}

  This is the syntax of the system in which we start, which we will call
  $\Se$.

  \[
    \begin{array}{l@{~}l@{~}l@{~}r@{~}l@{\quad}l}
      \Var  & \ni & x,y,X,Y \\
      \Sort & \ni & s             & ::= & \Type_k \mbox{ }
                                                (k \in \mathbb{N}) \\
      \Exp  & \ni & t,u,T,U & ::= & s \mid \Pi x:U.T \mid
                                    \Id T\ t\ u \\
                         &&& \mid & x \mid \lambda x:U.t \mid t~u
                               \mid \refl(T,t) \mid
                               \J (T,U,t_{refl},u_1,u_2,t_{eq}) \\
      \Ctx  & \ni & \Gamma  & ::= & \cdot \mid \Gamma, x:T \\
    \end{array}
  \]
  %
  We assume it contains $\mA$ and $\mB$ that are equivalent (and respectively in
  universes $\sA$ and $\sB$), but up to univalence, we only assume that
  there is $\me$ such that $\der \me : \Id s\ \mA\ \mB$ for some $s$
  (note: we will only treat the case where this holds in the empty context,
  but it should scale easily).
  We will write $\eta$ and $\epsilon$ for the section and retraction (even
  though they can be explicited with $\me$).

  We then extend this system with $\mR$, $\inj(t)$ and $\proj(t)$ as well as
  the following rules (which we will note with $\derr$ instead of $\derb$)
  (this one will be called $\Sr$).

  \begin{mathc}
    \ru{\derr \Gamma
      }{\Gamma \derr \mR : \sB}
    \qquad
    \ru{\Gamma \derr t : \mA
      }{\Gamma \derr \inj(t) : \mR}
    \qquad
    \ru{\Gamma \derr t : \mR
      }{\Gamma \derr \proj(t) : \mA}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \derr t : \mA
      }{\Gamma \derr \proj(\inj(t)) = t : \mA}
    \qquad
    \ru{\Gamma \derr t : \mR
      }{\Gamma \derr \inj(\proj(t)) = t : \mR}
  \end{mathc}

  Finally, we define $\Sb$ which is an intermediary for the translation
  with residuals for $\mR$ and $\me$ : $\mbB$ and $\mbe$.
  This is simply an extension of $\Se$ but where
  $\mbe : \Id s\ \mA\ \mbB$ and $\mbB$ behaves as $\mB$ but can be abstracted
  over, meaning we can destruct $\mbe$ (basically, $\mbB$ is a variable).
  We will also assume we have $\eta^\bullet$ and $\epsilon^\bullet$ which are
  basically $\eta$ and $\epsilon$ but on $\mbe$ instead of $\me$.

  \subsection{Translation with Residuals ($\Sr$ to $\Sb$)}

  Because our translation is based on the derivation of a judgement and not
  only the judgement itself, we need to have some criterium of compatibility.
  It will also be helpful to ensure that the empty type is mapped to something
  close to the empty type (as in, it is empty as well).

  We will write $\msigma$ for the substitution
  $[\mbB := \mA, \mbe := \refl(s,\mA)]$.
  And in the following $\Gamma \derb t = t'$ shall mean that there exists $A$
  such that $\Gamma \derb t = t' : A$ holds.
  %
  We want to be able to ``destruct'' $\mbe$, or rewrite $\mbB$ into $\mA$.
  To do so we use the following
  \[
    \de(C,b) := \J(s, \lambda \_, \mbB, \mbe. C, \lambda A. b, \mA, \mbB, \mbe).
  \]

  \begin{definition}[$\Gamma$-translation]
    For any context $\derb \Gamma$ we define the notion of $\Gamma$-translation
    of a term $u$ (in $\Sb$) by induction on $u$.
    \begin{itemize}
      \item $t$ is a $\Gamma$-translation of $s$ if
            $\Gamma \msigma \derb t \msigma = s$.
      \item $t$ is a $\Gamma$-translation of $\Pi x:A.B$ if
            $\Gamma \msigma \derb t \msigma = \Pi x:A'\msigma.B'\msigma$ where
            $A'$ is a $\Gamma$-translation of $A$ and $B'$ is a
            $(\Gamma, x:A')$-translation of $B$.
      \item $t$ is a $\Gamma$-translation of $\Id A\ u\ v$ if
            $\Gamma \msigma \derb t \msigma = \Id A'\msigma\ u'\msigma\ %
            v'\msigma$ where $A',u',v'$
            are $\Gamma$-translations of $A,u,v$ respectively.
      \item $t$ is a $\Gamma$-translation of $x$ if
            $\Gamma \msigma \derb t \msigma = x$.
      \item $t$ is a $\Gamma$-translation of $\lambda x:A.b$ if
            $\Gamma \msigma \derb t \msigma = \lambda x:A'\msigma.b'\msigma$
            where $A'$ is a $\Gamma$-translation of $A$ and $b'$ is a
            $(\Gamma, x:A')$-translation of $b$.
      \item $t$ is a $\Gamma$-translation of $a\ b$ if
            $\Gamma \msigma \derb t \msigma = a'\msigma\ b'\msigma$ where
            $a',b'$ are $\Gamma$-translations of $a,b$ respectively.
      \item $t$ is a $\Gamma$-tanslation of $\refl(A,u)$ if
            $\Gamma \msigma \derb t \msigma = \refl(A'\msigma,u'\msigma)$ where
            $A',u'$ are $\Gamma$-translations of $A,u$ respectively.
      \item \sloppy
            $t$ is a $\Gamma$-tanslation of $\J(A,C,b,u,v,p)$ if
            $\Gamma \msigma \derb t \msigma = \J(A',C',b',u',v',p')\msigma$
            where $A',C',b',u',v',p'$ are $\Gamma$-translations of
            $A,C,b,u,v,p$ respectively.
      \item $t$ is a $\Gamma$-translation of $\mR$ if
            $\Gamma \msigma \derb t \msigma = \mA$.
      \item $t$ is a $\Gamma$-translation of $\inj(u)$ if
            $\Gamma \msigma \derb t \msigma = u'\msigma$ where $u'$ is a
            $\Gamma$-translation of $u$.
      \item $t$ is a $\Gamma$-translation of $\proj(u)$ if
            $\Gamma \msigma \derb t \msigma = u'\msigma$ where $u'$ is a
            $\Gamma$-translation of $u$.
    \end{itemize}
  \end{definition}

  \begin{definition}[Context Translation]
    We define translations of a context $\Gamma$ by induction on $\Gamma$:
    \begin{itemize}
      \item $\cdot$ is a translation of $\cdot$.
      \item $\Gamma', x:A'$ is a translation of $\Gamma, x:A$ if $\Gamma'$ is
            a translation of $\Gamma$ and $A'$ is a $\Gamma'$-translation of
            $A$.
    \end{itemize}
  \end{definition}
  %
  Before dealing with our theorem, we will look at a few lemmata regarding the
  translation.

  \begin{lemma}[Equality of translations]
    \label{lem:transleq}
    If $t$ and $t'$ are both $\Gamma$-translations of the same term $u$ and if
    there exists $A$ such that $\Gamma \derb t, t' : T$ then there exists $e$
    such that $\Gamma \derb e : \Id T\ t\ t'$.
    %
    Besides, $\Gamma \msigma \derb e \msigma = \refl(T\msigma,t\msigma)$.
  \end{lemma}

  \begin{proof}
    Formally we prove by induction that
    $\Gamma \msigma \derb t \msigma = t' \msigma$
    meaning $\Gamma \msigma \derb t \msigma = t' \msigma : T\msigma$
    (to do so we rely on unicity of typing).
    Then we have
    \[
      \Gamma \derb \de(\Id T\ t\ t', \refl(T\msigma, t\msigma)) : Id T\ t\ t'.
    \]
    Under $\msigma$, $\me$ becomes $\refl$, so does the whole $\J/\de$.
  \end{proof}


  We can now go on defining the theorem using the above definitions.

  \begin{theorem}[Translation]
    \label{thm:transl}
    \leavevmode
    \begin{enumerate}
      \item If $\Gamma \derr t : T$ then there exists $\Gamma'$ a well-formed
      translation of $\Gamma$ and for any such $\Gamma'$, there are $t'$ and
      $T'$, $\Gamma'$-translations of $t$,$T$,
      such that $\Gamma' \derb t' : T'$.
      \item If $\Gamma \derr t = u : T$ then there exists $\Gamma'$ a
      well-formed translation of $\Gamma$ and for any such $\Gamma'$, there are
      $t'$, $u'$ and $T'$, $\Gamma'$-translations of $t$, $u$, $T$, and $h$ such
      that $\Gamma' \derb h : \Id T'\ t'\ u'$.
      \item If $\derr \Gamma$ then there exists $\Gamma'$ a translation of
      $\Gamma$ such that $\derb \Gamma'$.
    \end{enumerate}
  \end{theorem}

  \begin{proof}
    By induction on the derivation (we grayed out the cases that we deem
    simple or merely a reproduction of another case, meaning that you shouldn't
    have to focus on them if you want to get an idea of where the proof lies).

    \leavevmode
    \begin{caselist}
      \begin{graycase}
        \begin{mathc}
          \ru{}{\derr \cdot}
        \end{mathc}
        We have $\derb \cdot$, which corresponds to a valid translation.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr A : s
             }{\derr \Gamma, x ; A
             }{x \notin \dom \Gamma}
        \end{mathc}
        By induction hypothesis, we have $\Gamma' \derb A' : t$ a valid
        translation. By lemma~\ref{lem:transleq}, we have
        $\Gamma' \derb A'' : s$ which is still a valid translation.
        So $\derb \Gamma', x : A''$ and $\Gamma', x : A''$ is a translation of
        $\Gamma, x : A$.
        (Note: Being a translation means that $x \notin \Gamma$ ensures
        $x \notin \Gamma'$).
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\derr \Gamma
             }{\Gamma \derr s_1 : s_2
             }{(s_1,s_2)}
        \end{mathc}
        By induction hypothesis, $\derb \Gamma'$ is a translation.
        And so is $\Gamma' \derb s_1 : s_2$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\derr \Gamma
             }{\Gamma \derr x : A
             }{(x : A) \in \Gamma}
        \end{mathc}
        By induction hypothesis, $\derb \Gamma'$ is a translation and
        $(x : A') \in \Gamma'$ for $A'$ a translation of $A$.
        Thus $\Gamma' \derb x : A'$ is a valid translation.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr A : s_1 \qquad
               \Gamma, x : A \derr B : s_2
             }{\Gamma \derr \Pi x:A.B : s_3
             }{(s_1,s_2,s_3)}
        \end{mathc}
        By induction hypothesis, $\Gamma' \derb A' : t_1$ is a valid
        translation.
        By lemma~\ref{lem:transleq}, $\Gamma' \derb A' : s_1$ (up to transport).
        Thus, $\derb \Gamma', x : A'$, and so, by second induction hypothesis,
        $\Gamma', x:A' \derb B' : t_2$, but likewise, we assume we have
        $\Gamma', x:A' \derb B' : s_2$ instead.
        So $\Gamma' \derb \Pi x:A'.B' : s_3$ is a valid translation.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr A : s_1 \qquad
               \Gamma, x:A \derr b : B : s_2
             }{\Gamma \derr \lambda x:A.b : \Pi x:A.B
             }{(s_1,s_2,s_3)}
        \end{mathc}
        By induction hypotheses, $\Gamma' \derb A' : s_1$ (implicitely using
        lemma~\ref{lem:transleq}) and $\Gamma', x:A' \derb b' : B''$ and
        $\Gamma', x:A' \derb B' : s_2$.
        Using a transport\footnote{It is alright to assume that $B'$ and $B''$
        can have the same type (to use lemma~\ref{lem:transleq})
        thanks to cumulativity, combined with the fact that being on the right
        of colons, imply you can be typed by a sort.},
        we can assume $\Gamma', x:A' \derb b' : B'$ instead.
        Now, $\Gamma' \derb \lambda x:A'.b' : \Pi x:A'.B'$.
      \end{graycase}

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr F : \Pi x:A.B \qquad
            \Gamma \derr a : A
          }{\Gamma \derr F\ a : B[x := a]}
      \end{mathc}
      By induction hypotheses, $\Gamma' \derb F' : T$ and
      $\Gamma' \derb a' : A'$.
      Since $T$ is a translation of $\Pi x:A.B$, by definition, there exist
      $A''$ a $\Gamma'$-translation of $A$ and
      $B'$ a $(\Gamma', x:A'')$-translation of $B$.
      By lemma~\ref{lem:transleq}, we have $\Gamma' \derb h_* : A' \to A''$.
      The idea now is to ``destruct'' $\mbe$ so that $F'$ has a $\Pi$-type
      of domain the type of $a$:
      \[
        \Gamma' \derb \de(B'[x := h_*\ a'], F'\msigma\ a'\msigma) :
        B'[x := h_*\ a'].
      \]

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr A : s \qquad
              \Gamma \derr u : A \qquad
              \Gamma \derr v : A
            }{\Gamma \derr \Id A\ u\ v : s}
        \end{mathc}
        By induction hypotheses, $\Gamma' \derb A' : s$ (using the trick
        aforementioned), $\Gamma' \derb u' : A_u$ and $\Gamma' \derb v' : A_v$,
        using the same trick again, we assume $\Gamma' \derb u' : A'$ and
        $\Gamma' \derb v' : A'$.
        Thus, $\Gamma' \derb \Id A'\ u'\ v' : s$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr A : s \qquad
              \Gamma \derr u : A
            }{\Gamma \derr \refl(A,u) : \Id A\ u\ u}
        \end{mathc}
        By induction hypothesis, $\Gamma' \derb A' : s$ and
        $\Gamma' \derb u' : A'$ so
        $\Gamma' \derb \refl(A',u') : \Id A'\ u'\ u'$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \tru{\Gamma \derr A : s \qquad
               \Gamma \derr C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
             }{\Gamma \derr b : \Pi x:A. C\ x\ x\ \refl(A,x)
             }{\Gamma \derr u, v : A \qquad
               \Gamma \derr p : \Id A\ u\ v
             }{\Gamma \derr \J (A,C,b,u,v,p) : C\ u\ v\ p}
        \end{mathc}
        By induction hypotheses, $\Gamma' \derb A' : s$ and
        $\Gamma' \derb C' : \Pi x:A'. \Pi y:A'. (\Id A'\ x\ y) \to s'$ and
        $\Gamma' \derb b' : \Pi x:A'. C'\ x\ x\ \refl(A',x)$ and
        $\Gamma' \derb u' : A'$ and $\Gamma' \derb v : A'$ and
        $\Gamma' \derb p : \Id A'\ u'\ v'$ (the trick can be used as long as we
        have a valid translation, which we have in all of the cases above).
        Thus $\Gamma' \derb \J(A',C',b',u',v',p') : C'\ u'\ v'\ p'$.
      \end{graycase}

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr a : A \qquad
            \Gamma \derr A = B : s
          }{\Gamma \derr a : B}
      \end{mathc}
      By the first induction hypothesis, there are $\Gamma'$, $a'$ and $A'$
      such that $\Gamma' \derb a' : A'$ (and that are translations).
      Then, we can instantiate the second induction hypothesis with $\Gamma'$:
      we thus have $A'',B',t$ that are $\Gamma'$-translations of $A,B,s$ and
      $h$ such that $\Gamma' \derb h : \Id t\ A''\ B'$.
      By lemma~\ref{lem:transleq}, there is $h'$ such that
      $\Gamma' \derb h' : \Id s'\ A'\ A''$ for some $s'$.
      Then $\Gamma' \derb (h \cons h')_*\ a' : B'$ with everything being
      $\Gamma'$-translations.

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr a : A
            }{\Gamma \derr a = a : A}
        \end{mathc}
        By induction hypothesis, $\Gamma' \derb a' : A'$ and thus
        $\Gamma' \derb \refl(A',a') : \Id A'\ a'\ a'$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr a_1 = a_2 : A
            }{\Gamma \derr a_2 = a_1 : A}
        \end{mathc}
        By induction hypothesis, $\Gamma' \derb h : \Id A'\ a'_1\ a'_2$.
        Thus $\Gamma' \derb h\inv : \Id A'\ a'_2\ a'_1$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr a_1 = a_2 : A \qquad
              \Gamma \derr a_2 = a_3 : A
            }{\Gamma \derr a_1 = a_3 : A}
        \end{mathc}
        By induction hyoptheses (and using the ``trick''),
        $\Gamma' \derb h_1 : \Id A'\ a'_1\ a'_2$ and
        $\Gamma' \derb h_2 : \Id A'\ a'_2\ a'_3$.
        So $\Gamma' \derb h_1 \cons h_2 : \Id A'\ a'_1\ a'_3$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr a : A : s_1 \qquad
               \Gamma, x : A \derr b : B : s_2
             }{\Gamma \derr (\lambda x:A.b)\ a = b[x := a] : B[x := a]
             }{(s_1,s_2,s_3)}
        \end{mathc}
        By induction hypotheses, $\Gamma' \derb a' : A' : s_1$ and
        $\Gamma', x:A' \derb b' : B' : s_2$, then
        $\Gamma' \derb \refl(B'[x := a'], b'[x := a']) : \Id B'[x := a']\ %
        ((\lambda x:A'.b')\ a')\ b'[x := a']$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr A_1 = A_2 : s_1 \qquad
               \Gamma, x : A_1 \derr B_1 = B_2 : s_2
             }{\Gamma \derr \Pi x:A_1.B_1 = \Pi x:A_2.B_2
             }{(s_1,s_2,s_3)}
        \end{mathc}
        By induction hypotheses, $\Gamma' \derb h_1 : \Id s_1\ A'_1\ A'_2$
        and $\Gamma', x:A'_1 \derb h_2 : \Id s_2\ B'_1\ B'_2$.
        Thus,
        $\Gamma' \derb h_3 : \Id s_3\ (\Pi x:A'_1.B'_1)\ (\Pi x:A'_2.B'_2)$
        for some $h_3$ that we won't state out explicitely.
      \end{graycase}

      \nextcase
      \begin{mathc}
        \rux{\Gamma \derr A_1 = A_2 : s_1 \qquad
             \Gamma, x : A_1 \derr b_1 = b_2 : B : s_2
           }{\Gamma \derr \lambda x:A_1.b_1 = \lambda x:A_2.b_2 : \Pi x:A_1.B
           }{(s_1,s_2,s_3)}
      \end{mathc}
      By induction hypothesis, there are $\Gamma',A'_1,A'_2,t_1$ translations
      and $h$ such that $\Gamma' \derb h_1 : \Id t_1\ A'_1\ A'_2$.
      Thus, $\Gamma' \derb A'_1 : t_1$, and by lemma~\ref{lem:transleq}
      (noting that any sort is a translation of itself (modulo injection))
      we have $e_1$ such that $\Gamma' \derb e_1 : \Id s_4\ t_1\ s_1$ and
      then $\Gamma' \derb (e_1)_*\ A'_1 : s_1$.
      $\Gamma', x : (e_1)_*\ A'_1$ is a well-formed translation of
      $\Gamma, x:A$. We will write it $\Delta$ for short.

      We can instantiate the second hypothesis to get
      $\Delta \derb h_2 : \Id B'\ b'_1\ b'_2$ and $\Delta \derb B'' : t_2$.
      By lemma~\ref{lem:transleq}, we have $e_2,e_3$ such that
      $\Delta \derb e_2 : \Id s_5\ t_2\ s_2$ and
      $\Delta \derb (e_3)_* : B' \to (e_2)_*\ B''$.

      The problem is that
      \[
        \lambda (x : (e_1)_*\ A'_2). (e_3)_*\ %
        b'_2[x := ((e_1)_* (h_1\inv))_*\ x]
      \]
      has type
      $\Pi (x : (e_1)_*\ A'_2). (e_2)_*\ B''$ instead of
      $\Pi (x : (e_1)_*\ A'_1). (e_2)_*\ B''$.
      However these two types are equal thanks to $h_1$.
      (We could explicit it, but everyone should be convinced. We can then
      transport the whole $\lambda$ expression, we keep the translation
      property and thus equality by destructing $\mbe$).

      We finally have
      $\Gamma' \derb e_5 : \Id T\ u_1\ u_2$ for some $e_4,e_5$,
      where
      \[
        \begin{array}{l@{~}l}
          T   &:= \Pi (x : (e_1)_*\ A'_1). (e_2)_*\ B'' \\
          u_1 &:= \lambda (x : (e_1)_*\ A'_1). (e_3)_*\ b'_1 \\
          u_2 &:= (e_4)_*\ %
                   (\lambda (x : (e_1)_*\ A'_2).
                    (e_3)_*\ b'_2[x := ((e_1)_* (h_1\inv))_*\ x])
        \end{array}
      \]
      And everything behaves well under $\msigma$.

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr F_1 = F_2 : \Pi x:A.B \qquad
              \Gamma \derr a_1 = a_2 : A
            }{\Gamma \derr F_1\ a_1 = F_2\ a_2 : B[x := a_1]}
        \end{mathc}
        By induction hypotheses,
        $\Gamma' \derb h_1 : \Id (\Pi x:A'.B')\ F'_1\ F'_2$ and
        $\Gamma' \derb h_2 : \Id A'\ a'_1\ a'_2$ (here we use an elaborate
        version of the transport trick since the original translation gives us
        $A'$ and $B'$).
        The only problem here is that $F'_2\ a'_2$ would have type
        $B'[x := a'_2]$ instead of $B'[x := a'_1]$ but these two types are equal
        (as in, there exists an identity proof) so we can conclude with a
        transport around $F'_2\ a'_2$, but we won't state anything explicitely.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr A_1 = A_2 : s \qquad
              \Gamma \derr u_1 = u_2 : A_1 \qquad
              \Gamma \derr v_1 = v_2 : A_1
            }{\Gamma \derr \Id A_1\ u_1\ v_1 = \Id A_2\ u_2\ v_2 : s}
        \end{mathc}
        By induction hypothesis, $\Gamma' \derb h_A : \Id s\ A'_1\ A'_2$
        and $\Gamma' \derb h_u : \Id A'_1\ u'_1\ u'_2$ and
        $\Gamma' \derb h_v : \Id A'_1\ v'_1\ v'_2$.
        Destructing these three equalities \emph{is all it takes\footnote{Thus
        avoiding to do it \emph{in extenso} here.}} to prove
        $\Gamma' \derb h : \Id s\ (\Id A'_1\ u'_1\ v'_1)\ %
        (\Id A'_2\ ({h_A}_*\ u'_2)\ ({h_A}_*\ v'_2))$ for some $h$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr A_1 = A_2 : s \qquad
              \Gamma \derr u_1 = u_2 : A_1
            }{\Gamma \derr \refl(A_1,u_1) = \refl(A_2,u_2) : \Id A_1\ u_1\ u_1}
        \end{mathc}
        By induction hypotheses, $\Gamma' \derb h_A : \Id s\ A'_1\ A'_2$
        and $\Gamma' \derb h_u : \Id A'_1\ u'_1\ u'_2$.
        This case is treated as the previous one by saying there is an $h$
        such that $\Gamma' \derb h : \Id (\Id A'_1\ u'_1\ u'_1)\ %
        \refl(A'_1,u'_1)\ (h'_*\ \refl(A'_2,u'_2))$ where $h'$ is an equality
        like the one from the precedent case.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \tru{\Gamma \derr A_1 = A_2 : s \qquad
               \Gamma \derr C_1 = C_2 : \Pi x:A_1. \Pi y:A_1. (\Id A_1\ x\ y)
               \to s'
             }{\Gamma \derr b_1 = b_2 : \Pi x:A_1. C_1\ x\ x\ \refl(A_1,x)
             }{\Gamma \derr u_1 = u_2 : A_1 \qquad
               \Gamma \derr v_1 = v_2 : A_1 \qquad
               \Gamma \derr p_1 = p_2 : \Id A_1\ u_1\ v_1
             }{\Gamma \derr \J(A_1,C_1,b_1,u_1,v_1,p_1) =
               \J(A_2,C_2,b_2,u_2,v_2,p_2) :
               C_1\ u_1\ v_1\ p_1}
        \end{mathc}
        This is again treated the same way, with a transport on the right to
        make everything
        type\footnote{I don't think anyone would read it anyway.}.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \dru{\Gamma \derr A : s \qquad
               \Gamma \derr C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
             }{\Gamma \derr b : \Pi x:A. C\ x\ x\ \refl(A,x) \qquad
               \Gamma \derr u : A
             }{\Gamma \derr \J (A,C,b,u,u,\refl(A,u)) = b\ u :
               C\ u\ u\ \refl(A,u)}
        \end{mathc}
        This time, it's basically like $\beta$-reduction, we use $\refl$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr a_1 = a_2 : A_1 \qquad
              \Gamma \derr A_1 = A_2 : s
            }{\Gamma \derr a_1 = a_2 : A_2}
        \end{mathc}
        By induction hypotheses, $\Gamma' \derb h_a : \Id A'_1\ a'_1\ a'_2$
        and $\Gamma' \derb h_A : \Id s\ A'_1\ A'_2$.
        We easily get $h$ such that $\Gamma' \der h : \Id A'_2\ %
        ({h_A}_*\ a'_1)\ ({h_A}_*\ a'_2)$.
      \end{graycase}

      \nextcase
      \begin{mathc}
        \ru{\derr \Gamma
          }{\Gamma \derr \mR : \sB}
      \end{mathc}
      By induction hypothesis, there exists $\Gamma'$ a well-formed translation
      of $\Gamma$. And for any such translation, $\Gamma' \derb \mbB : \sB$
      which is a valid translation.

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr t : \mA
          }{\Gamma \derr \inj(t) : \mR}
      \end{mathc}
      By induction hypothesis, we have $\Gamma' \derb t' : A'$.
      Since $\mA$ and $A'$ can be equated (lemma~\ref{lem:transleq}),
      we have a transport $h_* : A' \to \mA$, so
      $\Gamma' \derb h_*\ t' : \mA$ and thus
      $\Gamma' \derb \mbe_*\ (h_*\ t') : \mB$ which gives us a desired
      translation.

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr t : \mR
          }{\Gamma \derr \proj(t) : \mA}
      \end{mathc}
      By induction hypothesis, $\Gamma' \derb t' : R'$.
      We can safely assume $\Gamma' \derb t' : \mB$ and thus
      $\Gamma' \derb {\mbe\inv}_*\ t' : \mA$.

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr t : \mA
          }{\Gamma \derr \proj(\inj(t)) = t : \mA}
      \end{mathc}
      By induction hypothesis, $\Gamma' \derb t' : \mA$.
      Then $\eta^\bullet\ t'$ is the proof we seek.

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr t : \mR
          }{\Gamma \derr \inj(\proj(t)) = t : \mR}
      \end{mathc}
      By induction hypothesis, $\Gamma' \derb t' : \mB$.
      Then $\epsilon^\bullet\ t'$ is the proof we seek.
    \end{caselist}
  \end{proof}

  \begin{corollary}[Consistency (with respect to $\Sb$)]
    \label{cor:cons1}
    The least type is not inhabited: $X : \Type_0 \nvdash_r t : X$
    (as long as it is not inhabited in $\Sb$).
  \end{corollary}

  \begin{proof}
    Let's write $\Gamma := X : \Type_0$ and assume $\Gamma \derr t : X$.
    Thus, by theorem~\ref{thm:transl}, we have $\Gamma \derb t' : T$ with
    the right translations (we indeed can choose whatever we want for the
    translation of $\Gamma$ and $\Gamma$ itself is valid).
    \Wlog, by lemma~\ref{lem:transleq}, we can assume
    $\Gamma \derb t' : X$ (by applying a transport to $t'$).
    Now, assuming that $\Sb$ is itself consistent, this is a contradiction.
    Thus, our system with resizing rules is consistent (with respect to $\Sb$).
  \end{proof}

  \subsection{Elimination of Residuals}

  This time, we will translate a judgement of $\Sb$ to a judgement of $\Se$
  in order to finally conclude on consistency (as $\Se$ can be seen as a subset
  of Coq).

  Our main tool will be the substitution of $\mbB$ by $\mB$, as $\mbB$ was only
  an abstraction of $\mB$. We write $\mrho$ for $[\mbB := \mB ; \mbe := \me]$.
  Remark: This is not an actual subsitution, even though we write it as one,
  it is merely a compact way of writing a translation that leaves everything
  unchanged but the bullets ($\bullet$) that it removes.

  \begin{theorem}[Erasure ($\Sb$ to $\Se$)]
    \label{thm:erase}
    If $\Gamma \derb t : T$ then $\Gamma\mrho \dere t\mrho : T\mrho$.
  \end{theorem}

  \begin{proof}
    The proof is straightforward as we eliminate all uses of $\mbe$ and $\mbB$
    at toplevel, while the others are shadowed (abstracted) and do not rely
    on the specific rules. Since $\mbe$ and $\mbB$ have the same typing rules
    as $\mB$ (the bullets are just tags), the complete derivation still holds.
  \end{proof}

  \begin{corollary}[Consistency of $\Sb$]
    \label{cor:cons2}
    $\Sb$ is consistent as long as $\Se$ is.
  \end{corollary}

  \begin{proof}
    By theorem~\ref{thm:erase}, $\Sb$ is consitent: $\mrho$ has no effect on
    $X$ (because $\mbB$ or $\mbe$ are not actual variables).
  \end{proof}

  \begin{corollary}[Consitency]
    $\Sr$ is consistent as long as $\Se$ is.
  \end{corollary}

  \begin{proof}
    Assuming $\Sr$ is inconsistent, by corollary~\ref{cor:cons1},
    $\Sb$ is inconsistent and thus, by corollary~\ref{cor:cons2},
    $\Se$ is inconsistent.
  \end{proof}

  \section{Consistency of Other Resizing Rules}

  Now that we treated the case of the resizing of equality by adding a
  pseudo-record $\mR$ representing the resized $\mA$ (\ie in the universe of
  $\mB$), we can handle different kinds of resizing rules as long as we assume
  some axioms.
  Please note that this is only to prove consistency, the user doesn't have to
  rely on these extra axioms.

  \paradot{Resizing of Equivalence}

  Assuming univalence, this one is pretty straightforward.
  Indeed, if two type are equivalent,
  they can be stated equal as a result of univalence. Instead of resizing an
  equivalence we are then resizing equality.

  \paradot{Resizing of Propositions}

  If we assume the law of excluded-middle, it is possible to create an
  equivalence between any mere proposition and either the empty type or the
  unit type (depending on the result of the excluded middle on this
  proposition). The only natural way of defining such maps yields an equivalence
  (coherences hold because of the proposition property or by \emph{exfalso}).

  Since, both the empty type and the unit type inhabit the smallest universe,
  by using the resizing for equivalence, we know that any mere proposition lives
  in the smallest universe (or equivalently any universe).

  In a similar fashion, one can resize the type of mere propositions to the
  smallest universe\footnote{Or any universe that shelters the booleans.} as
  well by remarking that it can be shown equivalent to
  the type of booleans in presence of the excluded middle.

  \paradot{Resizing of Embeddings}

  If we have an embedding $f$ of $A$ into $B$, then $A$ can be shown equivalent
  to its image through $f$ : $\{ b : B \mid \| \exists a:A. b = f(a) \| \}$.
  Since the squash is a mere proposition, the image can be resized to the
  universe of $B$ and so can $A$.

  Note that this rule entails the one on equivalence (and thus equality) and
  the one on propositions (but not the resizing of the type of propositions
  itself).

\end{document}
