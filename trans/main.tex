\documentclass[a4paper,english]{lipics-utf8x}

\usepackage[T1]{fontenc} %

\usepackage{amsmath, amssymb, amsfonts, stmaryrd}
\usepackage{bm}
\usepackage{pifont}
\PrerenderUnicode{é} % For the author names in the heading

% Add some colors
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{hyperref}
\hypersetup{
 linktocpage,
 colorlinks,
 citecolor=BlueViolet,
 filecolor=red,
 linkcolor=Blue,
 urlcolor=BrickRed
}

\usepackage{graphicx}
\usepackage{placeins}

% Meta comment
\newcommand\meta[1]{\noindent\textcolor{blue}{\emph{#1}}}

% Include the macro file
\input{macros}

% Title and so...
\title{Working Resizing of Equivalence under Univalence}
\author[1]{Théo Winterhalter}

\begin{document}

  \maketitle

  \begin{abstract}
    ...
  \end{abstract}

  \section{Our systems}

  This is the syntax of the system in which we start.

  \[
    \begin{array}{l@{~}l@{~}l@{~}r@{~}l@{\quad}l}
      \Var  & \ni & x,y,X,Y \\
      \Sort & \ni & s             & ::= & \Type_k \mbox{ }
                                                (k \in \mathbb{N}) \\
      \Exp  & \ni & t,u,T,U & ::= & s \mid \Pi x:U.T \mid
                                    \Id T\ t\ u \\
                         &&& \mid & x \mid \lambda x:U.t \mid t~u
                               \mid \refl(T,t) \mid
                               \J (T,U,t_{refl},u_1,u_2,t_{eq}) \\
      \Ctx  & \ni & \Gamma  & ::= & \cdot \mid \Gamma, x:T \\
    \end{array}
  \]
  %
  We assume it contains $\mA$ and $\mB$ that are equivalent (and respectively in
  universes $\sA$ and $\sB$), but up to univalence, we only assume that
  there is $\me$ such that $\der \me : \Id s\ \mA\ \mB$ for some $s$
  (note: we will only treat the case where this holds in the empty context,
  but it should scale easily).

  We then extend this system with $\mR$, $\inj(t)$ and $\proj(t)$ as well as
  the following rules (which we will note with $\derr$ instead of $\dere$).

  \begin{mathc}
    \ru{\derr \Gamma
      }{\Gamma \derr \mR : \sB}
    \qquad
    \ru{\Gamma \derr t : \mA
      }{\Gamma \derr \inj(t) : \mR}
    \qquad
    \ru{\Gamma \derr t : \mR
      }{\Gamma \derr \proj(t) : \mA}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \derr t : \mA
      }{\Gamma \derr \proj(\inj(t)) = t : \mA}
    \qquad
    \ru{\Gamma \derr t : \mR
      }{\Gamma \derr \inj(\proj(t)) = t : \mR}
  \end{mathc}

  \section{Translation for Consistency}

  Because our translation is based on the derivation of a judgement and not
  only the judgement itself, we need to have some criterium of compatibility.
  It will also be helpful to ensure that the empty type is mapped to something
  close to the empty type (as in, it is empty as well).

  We will write $\msigma$ for the substitution
  $[\mA := \mA, \mB := \mA, \me := \refl(s,\mA)]$.
  And in the following $\Gamma \dere t = t'$ shall mean that there exists $A$
  such that $\Gamma \dere t = t' : A$ holds.

  \begin{definition}[$\Gamma$-translation]
    For any context $\dere \Gamma$ we define the notion of $\Gamma$-translation
    of a term $u$ (in PTSe) by induction on $u$.
    \begin{itemize}
      \item $t$ is a $\Gamma$-translation of $s$ if
            $\Gamma \msigma \dere t \msigma = s$.
      \item $t$ is a $\Gamma$-translation of $\Pi x:A.B$ if
            $\Gamma \msigma \dere t \msigma = \Pi x:A'\msigma.B'\msigma$ where
            $A'$ is a $\Gamma$-translation of $A$ and $B'$ is a
            $(\Gamma, x:A')$-translation of $B$.
      \item $t$ is a $\Gamma$-translation of $\Id A\ u\ v$ if
            $\Gamma \msigma \dere t \msigma = \Id A'\msigma\ u'\msigma\ %
            v'\msigma$ where $A',u',v'$
            are $\Gamma$-translations of $A,u,v$ respectively.
      \item $t$ is a $\Gamma$-translation of $x$ if
            $\Gamma \msigma \dere t \msigma = x$.
      \item $t$ is a $\Gamma$-translation of $\lambda x:A.b$ if
            $\Gamma \msigma \dere t \msigma = \lambda x:A'\msigma.b'\msigma$
            where $A'$ is a $\Gamma$-translation of $A$ and $b'$ is a
            $(\Gamma, x:A')$-translation of $b$.
      \item $t$ is a $\Gamma$-translation of $a\ b$ if
            $\Gamma \msigma \dere t \msigma = a'\msigma\ b'\msigma$ where
            $a',b'$ are $\Gamma$-translations of $a,b$ respectively.
      \item $t$ is a $\Gamma$-tanslation of $\refl(A,u)$ if
            $\Gamma \msigma \dere t \msigma = \refl(A'\msigma,u'\msigma)$ where
            $A',u'$ are $\Gamma$-translations of $A,u$ respectively.
      \item \sloppy
            $t$ is a $\Gamma$-tanslation of $\J(A,C,b,u,v,p)$ if
            $\Gamma \msigma \dere t \msigma = \J(A',C',b',u',v',p')\msigma$
            where $A',C',b',u',v',p'$ are $\Gamma$-translations of
            $A,C,b,u,v,p$ respectively.
      \item $t$ is a $\Gamma$-translation of $\mR$ if
            $\Gamma \msigma \dere t \msigma = \mA$.
      \item $t$ is a $\Gamma$-translation of $\inj(u)$ if
            $\Gamma \msigma \dere t \msigma = u'\msigma$ where $u'$ is a
            $\Gamma$-translation of $u$.
      \item $t$ is a $\Gamma$-translation of $\proj(u)$ if
            $\Gamma \msigma \dere t \msigma = u'\msigma$ where $u'$ is a
            $\Gamma$-translation of $u$.
    \end{itemize}
  \end{definition}

  \begin{definition}[Context Translation]
    We define translations of a context $\Gamma$ by induction on $\Gamma$:
    \begin{itemize}
      \item $\cdot$ is a translation of $\cdot$.
      \item $\Gamma', x:A'$ is a translation of $\Gamma, x:A$ if $\Gamma'$ is
            a translation of $\Gamma$ and $A'$ is a $\Gamma'$-translation of
            $A$.
    \end{itemize}
  \end{definition}
  %
  Before dealing with our theorem, we will look at a few lemmata regarding the
  translation.

  \begin{lemma}[Equality of translations]
    \label{lem:transleq}
    If $t$ and $t'$ are both $\Gamma$-translations of the same term $u$ and if
    there exists $A$ such that $\Gamma \dere t, t' : T$ then there exists $e$
    such that $\Gamma \dere e : \Id T\ t\ t'$.
    %
    Besides, $\Gamma \msigma \dere e \msigma = \refl(T\msigma,t\msigma)$.
  \end{lemma}

  \begin{proof}
    Formally we prove by induction that
    $\Gamma \msigma \dere t \msigma = t' \msigma$
    meaning $\Gamma \msigma \dere t \msigma = t' \msigma : T\msigma$
    (to do so we rely on unicity of typing).
    Then we have
    \[\Gamma \dere \J(s,\lambda \mA, \mB, \me. \Id T\ t\ t',
    \lambda \mA. \refl(T\msigma,t\msigma),\mA,\mB,\me) : \Id T\ t\ t'.\]
    (implicitely, we replace $\mA,\mB,\me$ in $T,t,t'$ by the ones of the
    $\lambda$ which may not be really pretty, but you have to admit it's easier
    written this way, basically, the only thing this does is destructing
    equality $\me$ (as one would do in Coq) and then apply reflexivity).
    Under $\msigma$, $\me$ becomes $\refl$, so does the whole $\J$.
  \end{proof}


  We can now go on defining the theorem using the above definitions.

  \begin{theorem}[Translation]
    \label{thm:transl}
    \leavevmode
    \begin{enumerate}
      \item If $\Gamma \derr t : T$ then there exists $\Gamma'$ a well-formed
      translation of $\Gamma$ and for any such $\Gamma'$, there are $t'$ and
      $T'$, $\Gamma'$-translations of $t$,$T$,
      such that $\Gamma' \dere t' : T'$.
      \item If $\Gamma \derr t = u : T$ then there exists $\Gamma'$ a
      well-formed translation of $\Gamma$ and for any such $\Gamma'$, there are
      $t'$, $u'$ and $T'$, $\Gamma'$-translations of $t$, $u$, $T$, and $h$ such
      that $\Gamma' \dere h : \Id T'\ t'\ u'$.
      \item If $\derr \Gamma$ then there exists $\Gamma'$ a translation of
      $\Gamma$ such that $\dere \Gamma'$.
    \end{enumerate}
  \end{theorem}

  \begin{proof}
    By induction on the derivation.

    \leavevmode
    \begin{caselist}
      \begin{graycase}
        \begin{mathc}
          \ru{}{\derr \cdot}
        \end{mathc}
        We have $\dere \cdot$, which corresponds to a valid translation.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr A : s
             }{\derr \Gamma, x ; A
             }{x \notin \dom \Gamma}
        \end{mathc}
        By induction hypothesis, we have $\Gamma' \dere A' : t$ a valid
        translation. By lemma~\ref{lem:transleq}, we have
        $\Gamma' \dere A'' : s$ which is still a valid translation.
        So $\dere \Gamma', x : A''$ and $\Gamma', x : A''$ is a translation of
        $\Gamma, x : A$.
        (Note: Being a translation means that $x \notin \Gamma$ ensures
        $x \notin \Gamma'$).
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\derr \Gamma
             }{\Gamma \derr s_1 : s_2
             }{(s_1,s_2)}
        \end{mathc}
        By induction hypothesis, $\dere \Gamma'$ is a translation.
        And so is $\Gamma' \dere s_1 : s_2$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\derr \Gamma
             }{\Gamma \derr x : A
             }{(x : A) \in \Gamma}
        \end{mathc}
        By induction hypothesis, $\dere \Gamma'$ is a translation and
        $(x : A') \in \Gamma'$ for $A'$ a translation of $A$.
        Thus $\Gamma' \dere x : A'$ is a valid translation.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr A : s_1 \qquad
               \Gamma, x : A \derr B : s_2
             }{\Gamma \derr \Pi x:A.B : s_3
             }{(s_1,s_2,s_3)}
        \end{mathc}
        By induction hypothesis, $\Gamma' \dere A' : t_1$ is a valid
        translation.
        By lemma~\ref{lem:transleq}, $\Gamma' \dere A' : s_1$ (up to transport).
        Thus, $\dere \Gamma', x : A'$, and so, by second induction hypothesis,
        $\Gamma', x:A' \dere B' : t_2$, but likewise, we assume we have
        $\Gamma', x:A' \dere B' : s_2$ instead.
        So $\Gamma' \dere \Pi x:A'.B' : s_3$ is a valid translation.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \rux{\Gamma \derr A : s_1 \qquad
               \Gamma, x:A \derr b : B : s_2
             }{\Gamma \derr \lambda x:A.b : \Pi x:A.B
             }{(s_1,s_2,s_3)}
        \end{mathc}
        By induction hypotheses, $\Gamma' \dere A' : s_1$ (implicitely using
        lemma~\ref{lem:transleq}) and $\Gamma', x:A' \dere b' : B''$ and
        $\Gamma', x:A' \dere B' : s_2$.
        Using a transport\footnote{It is alright to assume that $B'$ and $B''$
        can have the same type (to use lemma~\ref{lem:transleq})
        thanks to cumulativity, combined with the fact that being on the right
        of colons, imply you can be typed by a sort.},
        we can assume $\Gamma', x:A' \dere b' : B'$ instead.
        Now, $\Gamma' \dere \lambda x:A'.b' : \Pi x:A'.B'$.
      \end{graycase}

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr F : \Pi x:A.B \qquad
            \Gamma \derr a : A
          }{\Gamma \derr F\ a : B[x := a]}
      \end{mathc}
      By induction hypotheses, $\Gamma' \dere F' : T$ and
      $\Gamma' \dere a' : A'$.
      Since $T$ is a translation of $\Pi x:A.B$, by definition, there exist
      $A''$ a $\Gamma'$-translation of $A$ and
      $B'$ a $(\Gamma', x:A'')$-translation of $B$.
      By lemma~\ref{lem:transleq}, we have $\Gamma' \dere h_* : A' \to A''$.
      The idea now is to ``destruct'' $\me$ so that $F'$ has a $\Pi$-type
      of domain the type of $a$. The way to do it is to use $\J$ as follows:
      \[
        \Gamma' \dere \J(s,\lambda \mA,\mB,\me. B'[x := h_*\ a'],
                         \lambda \mA. F'\msigma\ a'\msigma, \mA, \mB, \me) :
                      B'[x := h_*\ a'].
      \]

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr A : s \qquad
              \Gamma \derr u : A \qquad
              \Gamma \derr v : A
            }{\Gamma \derr Id A\ u\ v : s}
        \end{mathc}
        By induction hypotheses, $\Gamma' \dere A' : s$ (using the trick
        aforementioned), $\Gamma' \dere u' : A_u$ and $\Gamma' \dere v' : A_v$,
        using the same trick again, we assume $\Gamma' \dere u' : A'$ and
        $\Gamma' \dere v' : A'$.
        Thus, $\Gamma' \dere \Id A'\ u'\ v' : s$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \ru{\Gamma \derr A : s \qquad
              \Gamma \derr u : A
            }{\Gamma \derr \refl(A,u) : \Id A\ u\ u}
        \end{mathc}
        By induction hypothesis, $\Gamma' \dere A' : s$ and
        $\Gamma' \dere u' : A'$ so
        $\Gamma' \dere \refl(A',u') : \Id A'\ u'\ u'$.
      \end{graycase}

      \begin{graycase}
        \begin{mathc}
          \tru{\Gamma \derr A : s \qquad
               \Gamma \derr C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
             }{\Gamma \derr b : \Pi x:A. C\ x\ x\ \refl(A,x)
             }{\Gamma \derr u, v : A \qquad
               \Gamma \derr p : \Id A\ u\ v
             }{\Gamma \derr \J (A,C,b,u,v,p) : C\ u\ v\ p}
        \end{mathc}
        By induction hypotheses, $\Gamma' \dere A' : s$ and
        $\Gamma' \dere C' : \Pi x:A'. \Pi y:A'. (\Id A'\ x\ y) \to s'$ and
        $\Gamma' \dere b' : \Pi x:A'. C'\ x\ x\ \refl(A',x)$ and
        $\Gamma' \dere u' : A'$ and $\Gamma' \dere v : A'$ and
        $\Gamma' \dere p : \Id A'\ u'\ v'$ (the trick can be used as long as we
        have a valid translation, which we have in all of the cases above).
        Thus $\Gamma' \dere \J(A',C',b',u',v',p') : C'\ u'\ v'\ p'$.
      \end{graycase}

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr a : A \qquad
            \Gamma \derr A = B : s
          }{\Gamma \derr a : B}
      \end{mathc}
      By the first induction hypothesis, there are $\Gamma'$, $a'$ and $A'$
      such that $\Gamma' \dere a' : A'$ (and that are translations).
      Then, we can instantiate the second induction hypothesis with $\Gamma'$:
      we thus have $A'',B',t$ that are $\Gamma'$-translations of $A,B,s$ and
      $h$ such that $\Gamma' \dere h : \Id t\ A''\ B'$.
      By lemma~\ref{lem:transleq}, there is $h'$ such that
      $\Gamma' \dere h' : \Id s'\ A'\ A''$ for some $s'$.
      Then $\Gamma' \dere (h \cons h')_*\ a' : B'$ with everything being
      $\Gamma'$-translations.

      \nextcase
      \begin{mathc}
        \rux{\Gamma \derr A_1 = A_2 : s_1 \qquad
             \Gamma, x : A_1 \derr b_1 = b_2 : B : s_2
           }{\Gamma \derr \lambda x:A_1.b_1 = \lambda x:A_2.b_2 : \Pi x:A_1.B
           }{(s_1,s_2,s_3)}
      \end{mathc}
      By induction hypothesis, there are $\Gamma',A'_1,A'_2,t_1$ translations
      and $h$ such that $\Gamma' \dere h_1 : \Id t_1\ A'_1\ A'_2$.
      Thus, $\Gamma' \dere A'_1 : t_1$, and by lemma~\ref{lem:transleq}
      (noting that any sort is a translation of itself (modulo injection))
      we have $e_1$ such that $\Gamma' \dere e_1 : \Id s_4\ t_1\ s_1$ and
      then $\Gamma' \dere (e_1)_*\ A'_1 : s_1$.
      $\Gamma', x : (e_1)_*\ A'_1$ is a well-formed translation of
      $\Gamma, x:A$. We will write it $\Delta$ for short.

      We can instantiate the second hypothesis to get
      $\Delta \dere h_2 : \Id B'\ b'_1\ b'_2$ and $\Delta \dere B'' : t_2$.
      By lemma~\ref{lem:transleq}, we have $e_2,e_3$ such that
      $\Delta \dere e_2 : \Id s_5\ t_2\ s_2$ and
      $\Delta \dere (e_3)_* : B' \to (e_2)_*\ B''$.

      The problem is that
      \[
        \lambda (x : (e_1)_*\ A'_2). (e_3)_*\ b'_2[x := ((e_1)_* (h_1\inv))_*\ x]
      \]
      has type
      $\Pi (x : (e_1)_*\ A'_2). (e_2)_*\ B''$ instead of
      $\Pi (x : (e_1)_*\ A'_1). (e_2)_*\ B''$.
      However these two types are equal thanks to $h_1$.
      (We could explicit it, but everyone should be convinced. We can then
      transport the whole $\lambda$ expression, we keep the translation
      property and thus equality by destructing $e$).

      We finally have
      $\Gamma' \dere e_5 : \Id T\ u_1\ u_2$ for some $e_4,e_5$,
      where
      \[
        \begin{array}{l@{~}l}
          T   &:= \Pi (x : (e_1)_*\ A'_1). (e_2)_*\ B'' \\
          u_1 &:= \lambda (x : (e_1)_*\ A'_1). (e_3)_*\ b'_1 \\
          u_2 &:= (e_4)_*\ %
                   (\lambda (x : (e_1)_*\ A'_2).
                    (e_3)_*\ b'_2[x := ((e_1)_* (h_1\inv))_*\ x])
        \end{array}
      \]
      And everything behaves well under $\msigma$.

      \nextcase
      \begin{mathc}
        \ru{\derr \Gamma
          }{\Gamma \derr \mR : \sB}
      \end{mathc}
      By induction hypothesis, there exists $\Gamma'$ a well-formed translation
      of $\Gamma$. And for any such translation, $\Gamma' \dere \mB : \sB$
      which is a valid translation.

      \nextcase
      \begin{mathc}
        \ru{\Gamma \derr t : \mA
          }{\Gamma \derr \inj(t) : \mR}
      \end{mathc}
      By induction hypothesis, we have $\Gamma' \dere t' : A'$.
      Since $\mA$ and $A'$ can be equated (lemma~\ref{lem:transleq}),
      we have a transport $h_* : A' \to \mA$, so
      $\Gamma' \dere h_*\ t' : \mA$ and thus
      $\Gamma' \dere \me_*\ (h_*\ t') : \mB$ which gives us a desired
      translation.
    \end{caselist}
  \end{proof}

  \begin{corollary}[Consistency]
    The least type is not inhabited: $X : \Type_0 \nvdash_r t : X$.
  \end{corollary}

  \begin{proof}
    Let's write $\Gamma := X : \Type_0$ and assume $\Gamma \derr t : X$.
    Thus, by theorem~\ref{thm:transl}, we have $\Gamma \dere t' : T$ with
    the right translations (we indeed can choose whatever we want for the
    translation of $\Gamma$ and $\Gamma$ itself is valid).
    \Wlog, by lemma~\ref{lem:transleq}, we can assume
    $\Gamma \dere t' : X$ (by applying a transport to $t'$).
    Now, assuming that PTSe is itself consistent (we may rely on Coq consistency
    for instance), this is a contradiction.
    Thus, our system with resizing rules is consistent.
  \end{proof}

\end{document}
