\documentclass[a4paper,english]{lipics-utf8x}

\usepackage[T1]{fontenc} %

\usepackage{amsmath, amssymb, amsfonts, stmaryrd}
\usepackage{pifont}
\PrerenderUnicode{é} % For the author names in the heading

% Add some colors
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{hyperref}
\hypersetup{
 linktocpage,
 colorlinks,
 citecolor=BlueViolet,
 filecolor=red,
 linkcolor=Blue,
 urlcolor=BrickRed
}

\usepackage{graphicx}
\usepackage{placeins}

% Meta comment
\newcommand\meta[1]{\noindent\textcolor{blue}{\emph{#1}}}

% Include the macro file
\input{macros}

% Title and so...
\title{Squash me to the Smallest Universe}
\author[1]{Théo Winterhalter}

\begin{document}

  \maketitle

  \begin{abstract}
    This time we propose a development of a squash lying in the smallest
    universe (or any universe for that matter).
  \end{abstract}

  \section{Syntax}

  \[
    \begin{array}{l@{~}l@{~}l@{~}r@{~}l@{\quad}l}
      \Var  & \ni & x,y,X,Y \\
      \Sort & \ni & s             & ::= & \Type_k \mbox{ }
                                                (k \in \mathbb{N}) \\
      \Exp  & \ni & t,u,T,U & ::= & s \mid \Pi x:U.T \mid \Sigma x:U.T \mid
                                    t =_T u \mid \squash{T} \\
                         &&& \mid & x \mid \lambda x:U.t \mid t~u
                               \mid (t;u) \mid t.1 \mid t.2 \mid \refl_t \mid
                               \J (T,U,t_{refl},u_1,u_2,t_{eq}) \\
                         &&& \mid & [t] \mid \elim(T,U,f,h,t) \\
      \Ctx  & \ni & \Gamma  & ::= & \cdot \mid \Gamma, x:T \\
    \end{array}
  \]

  \noindent %
  We write $A \to B$ as short for $\Pi \_:A.B$, the non-dependent product.
  We also write $=$ for $=_T$ when $T$ is understood.

  The \emph{novelty} here, with respect to MLTT, is the introduction of a squash
  $\squash{T}$ with an injection $[t]$ from $T$, all of its inhabitants being
  definitionally equal (which I believe is key). The only way to eliminate is
  in a (semantically) irrelevant context, \ie through something hProp.
  This will be translated by $\elim$.
  Basically $\elim(A,B,f,h,a)$ takes $f : A \to B$ with
  $h : \Pi x:B. \Pi y:B. x = y$ and $a : \squash{A}$ to return a $B$.

  \section{Typing Rules}

  \begin{center}
  \(
    \ru{}{\der \cdot}
    \qquad
    \ru{\Gamma \der T : s \qquad
        x \notin \Gamma
      }{\der \Gamma, x : T}
    \qquad
    \ru{\der \Gamma
      }{\Gamma \der \Type_i : \Type_{i+1}}
    \qquad
    \ru{\der \Gamma \qquad
        (x : T) \in \Gamma
      }{\Gamma \der x : T}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : \Pi x:A.B \qquad
        \Gamma \der t' : A
      }{\Gamma \der t\ t' : B[t'/x]}
    \qquad
    \ru{\Gamma \der A : s \qquad
        \Gamma, x:A \der B : s' \qquad
        (s,s',s'') \in \R
      }{\Gamma \der \Pi x:A.B : s''}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der \Pi x:A.B : s \qquad
        \Gamma, x:A \der t : B
      }{\Gamma \der \lambda x:A.t : \Pi x:A.B}
    \qquad
    \ru{\Gamma \der t : \Sigma x:A.B
      }{\Gamma \der t.1 : A}
    \qquad
    \ru{\Gamma \der t : \Sigma x:A.B
      }{\Gamma \der t.2 : B[t.1/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der A : s \qquad
        \Gamma, x:A \der B : s' \qquad
        (s,s',s'') \in \R
      }{\Gamma \der \Sigma x:A.B : s''}
    \qquad
    \ru{\Gamma \der T : s \qquad
        \Gamma \der t,t' : T
      }{\Gamma \der t =_T t' : s}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : A \qquad
        \Gamma \der t' : B[t/x] \qquad
        \Gamma \der \Sigma x:A.B : s
      }{\Gamma \der (t;t') : \Sigma x:A.B}
    \qquad
    \ru{\Gamma \der t : T
      }{\Gamma \der \refl_t : t =_T t}
  \)
  \end{center}

  \begin{center}
  \(
    \tru{\Gamma \der A : s \qquad
         \Gamma \der C : \Pi x:A. \Pi y:A. (x =_A y) \to s'
       }{\Gamma \der b : \Pi x:A. C\ x\ x\ \refl_x
       }{\Gamma \der u, v : A \qquad
         \Gamma \der p : u =_A v
       }{\Gamma \der \J (A,C,b,u,v,p) : C\ u\ v\ p}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : A \qquad
        \Gamma \der B : s \qquad
        \Gamma \der A \le B
      }{\Gamma \der t : B}
  \)
  \end{center}

  \noindent %
  Now, we consider our rules for squash (acting as a resizing rule!).

  \begin{center}
  \(
    \ru{\Gamma \der A : \Type_i
      }{\Gamma \der \squash{A} : \Type_0}
    \qquad
    \ru{\Gamma \der t : A
      }{\Gamma \der [t] : \squash{A}}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der f : A \to B \qquad
        \Gamma \der h : \Pi_{x:A} \Pi_{y:A} x = y \qquad
        \Gamma \der a : \squash{A}
      }{\Gamma \der \elim(A,B,f,h,a) : B}
  \)
  \end{center}

  \section{Equality Rules}

  \paradot{Computation ($\beta$) and extensionality ($\eta$)}

  \begin{center}
  \(
    \ru{\Gamma, x:U \der t:V \qquad
        \Gamma \der u : U
      }{\Gamma \der (\lambda x:U.t)~u = t[u/x] : V[u/x]}
    \qquad
    \ru{\Gamma \der t : \Pi x:U.V
      }{\Gamma \der t = \lambda x:U.t~x : \Pi x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : U \qquad
        \Gamma \der t' : V[t/x]
      }{\Gamma \der (t;t').1 = t : U}
    \qquad
    \ru{\Gamma \der t : U \qquad
        \Gamma \der t' : V[t/x]
      }{\Gamma \der (t;t').2 = t' : V[t/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : \Sigma x:U.T
      }{\Gamma \der t = (t.1 ; t.2) : \Sigma x:U.T}
  \)
  \end{center}

  \begin{center}
  \(
    \dru{\Gamma \der A : s \qquad
         \Gamma \der C : \Pi x:A. \Pi y:A. (x =_A y) \to s'
       }{\Gamma \der b : \Pi x:A. C\ x\ x\ \refl_x \qquad
         \Gamma \der u : A
       }{\Gamma \der \J (A,C,b,u,u,\refl_u) = b\ u : C\ u\ u\ \refl_u}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der f : A \to B \qquad
        \Gamma \der h : \Pi_{x:A} \Pi_{y:A} x = y \qquad
        \Gamma \der t : A
      }{\Gamma \der \elim(A,B,f,h,[t]) = f\ t : B}
  \)
  \end{center}

  \paradot{Equivalence Rules}

  \begin{center}
  \(
    \ru{\Gamma \der t : T
      }{\Gamma \der t = t : T}
    \qquad
    \ru{\Gamma \der t' = t : T
      }{\Gamma \der t = t' : T}
    \qquad
    \ru{\Gamma \der t_1 = t_2 : T \qquad
        \Gamma \der t_2 = t_3 : T
      }{\Gamma \der t_1 = t_3 : T}
  \)
  \end{center}

  \paradot{Compatibility Rules}

  \begin{center}
  \(
    \rux{\Gamma \der U = U' : s \qquad
         \Gamma, x:U \der V = V' : s'
       }{\Gamma \der \Pi x:U.V = \Pi x:U'.V' : s''
       }{(s,s',s'')}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der U = U' : s \qquad
        \Gamma, x:U \der V : s' \qquad
        \Gamma, x:U \der t = t' : V
      }{\Gamma \der \lambda x:U.t = \lambda x:U'.t' : \Pi x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : \Pi x:U.V \qquad
        \Gamma \der u = u' : U
      }{\Gamma \der t~u = t'~u' : V[u/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{\Gamma \der U = U' : s \qquad
         \Gamma, x:U \der V = V' : s'
       }{\Gamma \der \Sigma x:U.V = \Sigma x:U'.V' : s''
       }{(s,s',s'')}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t_1 = t'_1 : U \qquad
        \Gamma, x:U \der V : s \qquad
        \Gamma \der t_2 = t'_2 : V[t_1/x]
      }{\Gamma \der (t_1;t_2) = (t'_1;t'_2) : \Sigma x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : \Sigma x:U.V
      }{\Gamma \der t.1 = t'.1 : U}
    \qquad
    \ru{\Gamma \der t = t' : \Sigma x:U.V
      }{\Gamma \der t.2 = t'.2 : V[t.1/x]}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der T = T' \qquad
        \Gamma \der t = t' : T \qquad
        \Gamma \der u = u' : T
      }{\Gamma \der t =_T u = t' =_{T'} u'}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : T \qquad
      }{\Gamma \der \refl_t = \refl_{t'} : t =_T t}
  \)
  \end{center}

  \begin{center}
  \(
    \tru{\Gamma \der A = A' : s \qquad
         \Gamma \der C = C' : \Pi x:A. \Pi y:A. (x =_A y) \to s'
       }{\Gamma \der b = b' : \Pi x:A. C\ x\ x\ \refl_x
       }{\Gamma \der u = u' : A \qquad
         \Gamma \der v = v' : A \qquad
         \Gamma \der p = p' : u =_A v
       }{\Gamma \der \J (A,C,b,u,v,p) = \J (A',C',b',u',v',p') : C\ u\ v\ p}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der A = A' : s
      }{\Gamma \der \squash{A} = \squash{A'} : \Type_0}
    \qquad
    \ru{\Gamma \der t, t' : \squash{A}
      }{\Gamma \der t = t' : \squash{A}}
  \)
  \end{center}

  \begin{center}
  \(
    \dru{\Gamma \der A = A' : s \qquad
         \Gamma \der B = B' : s'
       }{\Gamma \der f = f' : A \to B \qquad
         \Gamma \der h, h' : \Pi_{x:A} \Pi_{y:A} x = y \qquad
         \Gamma \der a, a' : \squash{A}
       }{\Gamma \der \elim(A,B,f,h,a) = \elim(A,B,f,h,a) : B}
  \)
  \end{center}

  \paradot{Conversion Rule}

  \begin{center}
  \(
    \ru{\Gamma \der t = t' : T \quad
        \Gamma \der T \le T'
      }{\Gamma \der t = t' : T'}
  \)
  \end{center}

  \section{Cumulativity}

  \begin{center}
  \(
    \rux{}{\Gamma \der \Type_i \le \Type_j}{i \le j}
    \qquad
    \ru{\Gamma \der U = U' : s \qquad
        \Gamma, x:U \der T \le T'
      }{\Gamma \der \Pi x:U.T \le \Pi x:U'.T'}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der T = T' : s
      }{\Gamma \der T \le T'}
    \qquad
    \ru{\Gamma \der T_1 \le T_2 \qquad
        \Gamma \der T_2 \le T_3
      }{\Gamma \der T_1 \le T_3}
  \)
  \end{center}

  \section{Consistency}

  While, initially, the Kripke logical relation we're going to define was
  created to prove soundness of algorithmic equality, we will mainly focus
  on consistency. We might handle decidability later.

  \paradot{Weak head normalization}

  Weak head normal forms (whnfs) are given by the following grammar:

  \begin{align*}
    \Whnf &\ni a,f,A,B,F &::=~& \Pi x:U.T \mid \Sigma x:U.T \mid t =_T u
                           \mid \squash{T} \\
        &&\mid~& n \mid \lambda x:U.t \mid (t;u) \mid \refl_t \mid [t] \\
    \Wne  &\ni n,N &::=~& x \mid n~u \mid n.1 \mid n.2 \mid \elim(T,U,t,u,n)
                           \mid \J (T,U,b,u,v,n)
  \end{align*}
  %
  We present weak-head reduction as follows:

  \begin{center}
  \(
    \ru{t \rew f \qquad
        f~u \rew a
      }{t~u \rew a}
    \qquad
    \ru{}{a \rew a}
    \qquad
    \ru{t[u/x] \rew a
      }{(\lambda x:U.t)~u \rew a}
    \qquad
    \ru{}{n~u \rew n~u}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{t \rew (u;v) \qquad
        u \rew a
      }{t.1 \rew a}
    \qquad
    \ru{t \rew (u;v) \qquad
        v \rew a
      }{t.2 \rew a}
    \qquad
    \ru{t \rew n
      }{t.1 \rew n.1}
    \qquad
    \ru{t \rew n
      }{t.2 \rew n.2}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{p \rew \refl_t \qquad
        u \rew a \qquad
        v \rew a \qquad
        t \rew a \qquad
        b\ u \rew a'
      }{\J (T,U,b,u,v,p) \rew a'}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{p \rew n
      }{\J (T,U,b,u,v,p) \rew \J (T,U,b,u,v,n)}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{v \rew [v'] \qquad
        t\ v' \rew a
      }{\elim(T,U,t,u,v) \rew a}
    \qquad
    \ru{v \rew n
      }{\elim(T,U,t,u,v) \rew \elim(T,U,t,u,n)}
  \)
  \end{center}
  %
  We will write $\red t$ for $a$ when $t \rew a$.

  \paradot{An Induction Measure}

  In order to define the logical relation, we define semantic universe
  hierarchy.
  By recursion on $i \in \mathbb{N}$, we define
  $\U_i \in \Whnf \times \mathcal{P}(\Whnf)$ as follows.

  \begin{center}
  \(
    \ru{}{(N, \Wne) \in \U_i}
    \qquad
    \rux{}{(\Type_i, \mid \U_i \mid) \in \U_j}{(\Type_i,\Type_j)}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{(U, \mathcal{A}) \in \widehat{U_i} \qquad
         \forall u \in \widehat{\mathcal{A}}.\ (T[u/x],\mathcal{F}(u)) \in
         \widehat{\U_j}
       }{(\Pi x:U.T, \Pi \mathcal{A} \mathcal{F}) \in \U_k
       }{(\Type_i, \Type_j, \Type_k)}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{(U, \mathcal{A}) \in \widehat{\U_i} \qquad
        \forall u \in \widehat{\mathcal{A}},\ (V[u/x], \mathcal{F}(u)) \in
        \widehat{\U_j}
       }{(\Sigma x:U.V, \Sigma \mathcal{A} \mathcal{F}) \in \U_k
       }{(\Type_i, \Type_j, \Type_k)}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{(T,\mathcal{A}) \in \U_i
      }{(u =_T v, \oeq\ \mathcal{A}\ u\ v) \in \U_i}
    \qquad
    \ru{}{(\squash{A}, \Squash) \in \U_i}
  \)
  \end{center}

  \noindent %
  Here, $\mathcal{A}$ denotes sets of expressions, $\mathcal{F}$ functions from
  expressions to set of expressions while
  $\widehat{\U_i} = \{ (T,\mathcal{A}) \mid (\red T, \mathcal{A}) \in \U_i \}$
  and $\mid \U_i \mid = \{ A \mid (A, \mathcal{A}) \in \U_i \text{ for some }
  \mathcal{A} \}$.
  $\widehat{\mathcal{A}} = \{ t \mid \red t \in \mathcal{A} \}$ is the closure
  of $\mathcal{A}$ by weak head expansion.
  The dependent function space is defined as
  $\Pi \mathcal{A} \mathcal{F} = \{ f \in \Whnf \mid \forall u \in
  \widehat{\mathcal{A}},\ f~u \in \widehat{\mathcal{F}(u)} \}$.
  The dependent sum space is defined as
  $\Sigma \mathcal{A} \mathcal{F} = \{ f \in \Whnf \mid f.1 \in
  \widehat{\mathcal{A}} \text{ and } f.2 \in \widehat{\mathcal{F}(f.1)} \}$.
  The equality space is defined as
  $\oeq\ \mathcal{A}\ u\ v = \Wne \bigcup \{ \refl_t \mid t \in
  \widehat{\mathcal{A}} \}$.
  Finally, the squash space is just
  $\Squash = \Wne \bigcup \{ [t] \mid \red t \in \Whnf \}$.

  \paradot{A Kripke Logical Relation}

  Let $\Gamma \der t :=: t' : T$ stand for the conjunction of propositions
  \begin{center}
  \(
    \Gamma \der t : T
    \qquad
    \Gamma \der t' : T
    \qquad
    \Gamma \der t = t' : T.
  \)
  \end{center}
  %
  By induction on $A \in s$, we define two Kripke relations:
  \begin{center}
  \(
    \Gamma \der A \Sr A' : s
    \qquad
    \Gamma \der a \Sr a' : A
  \)
  \end{center}
  together with their respective closures $\hSr$.
  We define them in rule form for better readability meaning we have to see the
  conclusion to be defined as the conjunction of the premises.

  \begin{center}
  \(
    \ru{\Gamma \der N :=: N'
      }{\Gamma \der N \Sr N'}
    \qquad
    \ru{\Gamma \der n :=: n' : N
      }{\Gamma \der n \Sr n' : N}
    \qquad
    \rux{\der \Gamma
       }{\Gamma \der s \Sr s : s'
       }{(s,s')}
  \)
  \end{center}

  \begin{center}
  \(
    \trux{\Gamma \der U \hSr U' : s
        }{\forall \Delta \le \Gamma,\ \Delta \der u \hSr u' : U \gives
          \Delta \der V[u/x] \hSr V'[u'/x] : s'
        }{\Gamma \der \Pi x:U.V :=: \Pi x:U'.V' : s''
        }{\Gamma \der \Pi x:U.V \Sr \Pi x:U'.V' : s''
        }{(s,s',s'')}
  \)
  \end{center}

  \begin{center}
  \(
    \dru{\forall \Delta \le \Gamma,\ \Delta \der u \hSr u' : U \gives
         \Delta \der f~u \hSr f'~u' : V[u/x]
       }{\Gamma \der f :=: f' : \Pi x:U.V
       }{\Gamma \der f \Sr f' : \Pi x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \trux{\Gamma \der U \hSr U' : s
        }{\forall \Delta \le \Gamma,\ \Delta \der u \hSr u' : U \gives
          \Delta \der V[u/x] \hSr V'[u'/x] : s'
        }{\Gamma \der \Sigma x:U.V :=: \Sigma x:U'.V' : s''
        }{\Gamma \der \Sigma x:U.V \Sr \Sigma x:U'.V' : s''
        }{(s,s',s'')}
  \)
  \end{center}

  \begin{center}
  \(
    \dru{\Gamma \der f.1 \hSr f'.1 : U \qquad
         \Gamma \der f.2 \hSr f'.2 : V[f.1/x]
       }{\Gamma \der f :=: f' : \Sigma x:U.V
       }{\Gamma \der f \Sr f' : \Sigma x:U.V}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der T :=: T' : s
      }{\Gamma \der \squash{T} \Sr \squash{T'} : s'}
    \qquad
    \ru{\Gamma \der f : \squash{T} \qquad
        \Gamma \der f' : \squash{T}
      }{\Gamma \der f \Sr f' : \squash{T}}
  \)
  \end{center}

  \begin{center}
  \(
    \qru{T \rew A \qquad
         \Gamma \der T = A
       }{t \rew a \qquad
         \Gamma \der t = a : A \qquad
         \Gamma \der t' = a' : A \qquad
         t' \rew a'
       }{\Gamma \der a \Sr a' : A
       }{\Gamma \der t :=: t' : T
       }{\Gamma \der t \hSr t' : T}
  \)
  \end{center}

  \begin{lemma}[Weakening]
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der a \Sr a' : A$ and $\Delta \le \Gamma$ then there
      exists a derivation of $\Delta \der a \Sr a' : A$ with the same height.
      \item Analogously for $\Gamma \der t \hSr t' : T$.
    \end{itemize}
  \end{lemma}
  %
  I dont' believe it's necessary to focus on this one.

  \begin{lemma}[Type Conversion]
    \label{lem:s-conv}
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der A \Sr A' : s$ then
      $\Gamma \der a \Sr a' : A$ iff $\Gamma \der a \Sr a' : A'$.
      \item If $\Gamma \der T \hSr T' : s$ then
      $\Gamma \der t \hSr t : T$ iff $\Gamma \der t \Sr t' : T'$.
    \end{itemize}
  \end{lemma}

  \begin{proof}
    Simultaneously by induction on $A \in s$ and $T \in s$.
    We only show the ``if'' direction.

    In all the proofs, we'll only focus on the squash, since it's the only
    thing that changes (forgetting sigma and equality on purpose) from
    Andreas and Gabriel's work.

    \begin{center}
    \(
      \ru{\Gamma \der T :=: T' : s
        }{\Gamma \der \squash{T} \Sr \squash{T'} : s'}
      \qquad
      \ru{\Gamma \der f : \squash{T} \qquad
          \Gamma \der f' : \squash{T}
        }{\Gamma \der f \Sr f' : \squash{T}}
    \)
    \end{center}
    %
    By conversion for typing, $\Gamma \der f, f' : \squash{T'}$, hence the
    result.
  \end{proof}

  \begin{lemma}[Symmetry and Transitivity]
    \label{lem:s-per}
    Let $\Gamma \der T \hSr T : s$.
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der t \hSr t' : T$ then $\Gamma \der t' \hSr t : T$.
      \item If $\Gamma \der t_1 \hSr t_2 : T$ and $\Gamma \der t_2 \hSr t_3 : T$
      then $\Gamma \der t_1 \hSr t_3 : T$.
    \end{itemize}
  \end{lemma}

  \begin{proof}
    We generalize the two statements to whnfs $\Gamma \der A \Sr A : s$ and
    prove all four statements simultaneously by induction.

    \begin{center}
    \(
      \ru{\Gamma \der T :=: T' : s
        }{\Gamma \der \squash{T} \Sr \squash{T'} : s'}
    \)
    \end{center}

    \begin{caselist}
      \nextcase Symmetry.
      \begin{center}
      \(
        \ru{\Gamma \der f : \squash{T} \qquad
            \Gamma \der f' : \squash{T}
          }{\Gamma \der f \Sr f' : \squash{T}}
      \)
      \end{center}
      Symmetry holds directly.

      \nextcase Transitivity also holds immediately.
    \end{caselist}
  \end{proof}

  \begin{lemma}[Into the logical relation]
    Let $T \in s$.
    If $\Gamma \der n :=: n' : T$ then $\Gamma \der n \hSr n' : T$.
  \end{lemma}
  %
  Once again the proof extends trivially.

  \paradot{Validity in the Model}

  We now extend our logical relation $\hSr$ to substitutions by
  induction on the destination context.
  %
  \begin{center}
  \(
    \ru{}{\Delta \der \sigma \hSr \sigma' : \cdot}
    \qquad
    \ru{\Delta \der \sigma \hSr \sigma' : \Gamma \qquad
        \Delta \der \sigma(x) \hSr \sigma'(x) : U \sigma
      }{\Delta \der \sigma \hSr \sigma' : \Gamma, x:U}
  \)
  \end{center}
  This relation inherits weakening from $\hSr$ for terms.

  We then define the context ($\Der \Gamma$), type ($\Gamma \Der T = T'$) and
  term ($\Gamma \Der t = t' : T$) validity relations by induction on the length
  of contexts.

  \begin{mathc}
    \ru{}{\Der \cdot}
    \qquad
    \ru{\Der \Gamma \qquad
        \Gamma \Der U
      }{\Der \Gamma, x:U}
    \qquad
    \ru{\Gamma \Der T = T' : s
      }{\Gamma \Der T = T'}
    \qquad
    \ru{\Gamma \Der T = T
      }{\Gamma \Der T}
  \end{mathc}

  \begin{mathc}
    \dru{\Der \Gamma \qquad
         (\Gamma \Der T \text{ unless } T = s)
       }{\forall \Delta, \sigma, \sigma',
         \Delta \der \sigma \hSr \sigma' : \Gamma \gives
         \Delta \der t \sigma \hSr t' \sigma' : T \sigma
       }{\Gamma \Der t = t' : T}
    \qquad
    \ru{\Gamma \Der t = t : T
      }{\Gamma \Der t : T}
  \end{mathc}

  \begin{lemma}[Substitution Relation is a PER]
    If $\Der \Gamma$, then $\Delta \der \_ \hSr \_ : \Gamma$ is symmetric and
    transitive.
  \end{lemma}
  %
  The proof is identical.

  \begin{lemma}[Validity is a PER]
    The relation $\Gamma \Der \_ = \_ : T$ is symmetric and transitive.
  \end{lemma}
  Again, this doesn't look at the terms in detail as long as they verify
  lemmata~\ref{lem:s-conv} and \ref{lem:s-per}.

  \begin{lemma}[Function type injectivity is valid]
    \label{lem:fun-inj-valid}
    If $\Gamma \Der \Pi x:U.T = \Pi x:U'.T'$ then $\Gamma \Der U = U'$ and
    $\Gamma, x:U \Der T = T'$.
  \end{lemma}
  This doesn't talk about the squash.

  \meta{Perhaps we would need similar lemmata for sigma, equality and squash.}

  \begin{lemma}[Context Satisfiable]
    If $\Der \Gamma$ then $\der \Gamma$ and $\Gamma \der \id \hSr \id : \Gamma$.
  \end{lemma}
  Nothing new.

  We can show that every equation valid in the model is derivable.
  \begin{lemma}[Completeness of rules]
    If $\Gamma \Der t = t' : T$ then $\Gamma \der t : T$ and
    $\Gamma \der t' : T$ and $\Gamma \der t = t' : T$ and $\Gamma \der T$.
  \end{lemma}
  Again, everything's fine.

  \paradot{Fundamental Theorem}
  We prove a series of lemmata which constitute parts of the fundamental theorem
  for the Kripke logical relation.

  \begin{lemma}[Validity of $\beta$-reduction]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma, x:U \Der t : T \qquad
          \Gamma \Der u : U
        }{\Gamma \Der (\lambda x:U.t)\ u = t[u/x] : T[u/x]}
    \end{mathc}
  \end{lemma}
  All ok.

  \begin{lemma}[Validity of $\eta$]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der t : \Pi x:U.T
        }{\Gamma \Der t = \lambda x:U.t\ x : \Pi x:U.T}
    \end{mathc}
  \end{lemma}
  No problem.

  \begin{lemma}[Validity of function equality]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der U = U' \qquad
          \Gamma, x:U \Der t = t' : T
        }{\Gamma \Der \lambda x:U.t = \lambda x:U'.t' : \Pi x:U.T}
    \end{mathc}
  \end{lemma}
  Ok.

  \meta{We need something similar as the three previous lemmata for sigmas and
  equality. We only treat the case of squash for now.}

  \begin{lemma}[Validity of $\elim$ reduction]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der f : U \to T \qquad
          \Gamma \Der h : \Pi_{x:T} \Pi_{y:T} x = y \qquad
          \Gamma \Der t : U
        }{\Gamma \Der \elim(U,T,f,h,[t]) = f\ t : T}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    $\Der \Gamma$ is contained in any of the hypothesese.
    $\Gamma \Der T$ is implied by $\Gamma \Der f : U \to T$ and
    lemma~\ref{lem:fun-inj-valid}.
    %
    Now assume $\Delta, \sigma, \sigma'$ such that
    $\Delta \der \sigma \hSr \sigma' : \Gamma$ and
    show
    \[\Delta \der \elim(U \sigma,T \sigma,f \sigma,h \sigma,[t \sigma]) \hSr
    f \sigma'\ t \sigma' : T \sigma.\]
    Since $\Gamma \Der T$, there exists $A$ in whnf such that $T \sigma \rew A$
    and $\Delta \der T \sigma = A$.
    We instantiate the first hypothesis to get
    $\Delta \der f \sigma \hSr f \sigma' : U \sigma \to T \sigma$
    and the last to get
    $\Delta \der t \sigma \hSr t' \sigma' : U \sigma$.
    We then get
    $\Delta \der f \sigma\ t \sigma \hSr f \sigma'\ t \sigma' : T \sigma$.
    With that we have $f \sigma\ t \sigma \rew a$ for some $a$ and since
    $[t \sigma] \rew [t \sigma]$, we deduce
    $\elim(U \sigma,T \sigma,f \sigma,h \sigma,[t \sigma]) \rew a$.

    \noindent %
    $\Delta \der \elim(U \sigma,T \sigma,f \sigma,h \sigma,[t \sigma]) = a : A$
    is deduced form transitivity.
    We also have $f \sigma'\ t \sigma' \rew a'$ for some $a'$ and
    $\Delta \der f \sigma'\ t \sigma' = a' : A$
    and $\Delta \der a \Sr a' : A$ which concludes our proof.
  \end{proof}

  \begin{lemma}[Validity of squash irrelevance]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der t : \squash{T} \qquad
          \Gamma \Der t' : \squash{T}
        }{\Gamma \Der t = t' : \squash{T}}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    $\Der \Gamma$ is trivial again, same as $\Gamma \Der \squash{T}$.
    Now assume $\Delta, \sigma, \sigma'$ such that
    $\Delta \der \sigma \hSr \sigma' : \Gamma$ and
    show $\Delta \der t \sigma \hSr t' \sigma' : \squash{T \sigma}$.
    By instantiating the hypotheses, we have $a,a',b,b'$ in whnf such that
    $t \sigma \rew a$ and $t \sigma' \rew a'$ and $t' \sigma \rew b$
    and $t' \sigma' \rew b'$ with the corresponding equalities under the type
    $\squash{T \sigma}$.

    We have to show $\Delta \der t \sigma :=: t' \sigma' : \squash{T \sigma}$
    and $\Delta \der a \Sr b' : \squash{T \sigma}$. They both hold by
    well-typing and irrelevance on squashes.
  \end{proof}

  \begin{theorem}[Fundamental theorem of logical relations]
    \leavevmode
    \begin{itemize}
      \item If $\der \Gamma$ then $\Der \Gamma$.
      \item If $\Gamma \der t : T$ then $\Gamma \Der t : T$.
      \item If $\Gamma \der t = t' : T$ then $\Gamma \Der t = t' : T$.
    \end{itemize}
  \end{theorem}

  \begin{proof}
    By induction on the derivation.
  \end{proof}

  \begin{corollary}[Syntactic validity]
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der t : T$ then $\Gamma \der T$.
      \item If $\Gamma \der t = t' : T$ then $\Gamma \der t : T$ and
      $\Gamma \der t' : T$.
    \end{itemize}
  \end{corollary}
  Alright.

\end{document}
