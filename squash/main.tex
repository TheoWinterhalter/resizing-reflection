\documentclass[a4paper,english]{lipics-utf8x}

\usepackage[T1]{fontenc} %

\usepackage{amsmath, amssymb, amsfonts, stmaryrd}
\usepackage{pifont}
\PrerenderUnicode{é} % For the author names in the heading

% Add some colors
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{hyperref}
\hypersetup{
 linktocpage,
 colorlinks,
 citecolor=BlueViolet,
 filecolor=red,
 linkcolor=Blue,
 urlcolor=BrickRed
}

\usepackage{graphicx}
\usepackage{placeins}

% Meta comment
\newcommand\meta[1]{\noindent\textcolor{blue}{\emph{#1}}}

% Include the macro file
\input{macros}

% Title and so...
\title{The squash is small}
\author[1]{Théo Winterhalter}

\begin{document}

  \maketitle

  \begin{abstract}
    This time we propose a development of a squash lying in the smallest
    universe (or any universe for that matter).
  \end{abstract}

  \section{Syntax}

  \[
    \begin{array}{l@{~}l@{~}l@{~}r@{~}l@{\quad}l}
      \Var  & \ni & x,y,X,Y \\
      \Sort & \ni & s             & ::= & \Type_k \mbox{ }
                                                (k \in \mathbb{N}) \\
      \Exp  & \ni & t,u,T,U & ::= & s \mid \Pi x:U.T \mid
                                    \Id T\ t\ u \mid \squash{T} \\
                         &&& \mid & x \mid \lambda x:U.t \mid t~u
                               \mid \refl_t \mid
                               \J (T,U,t_{refl},u_1,u_2,t_{eq}) \\
                         &&& \mid & [t] \mid \elim(T,U,f,h,t)
                             \mid \seq(T,t,u) \\
      \Ctx  & \ni & \Gamma  & ::= & \cdot \mid \Gamma, x:T \\
    \end{array}
  \]

  \noindent %
  We write $A \to B$ as short for $\Pi \_:A.B$, the non-dependent product.

  The \emph{novelty} here, with respect to MLTT, is the introduction of a squash
  $\squash{T}$ with an injection $[t]$ from $T$, all of its inhabitants being
  definitionally equal. The only way to eliminate is in a (semantically)
  irrelevant context, \ie through something hProp.
  This will be translated by $\elim$.
  Basically $\elim(A,B,f,h,a)$ takes $f : A \to B$ with
  $h : \Pi x:B. \Pi y:B. \Id B\ x\ y$ and $a : \squash{A}$ to return a $B$
  as long as $B$ is not a sort (and thus, not a variable).

  \section{Typing Rules}

  \begin{center}
  \(
    \ru{}{\der \cdot}
    \qquad
    \ru{\Gamma \der T : s \qquad
        x \notin \Gamma
      }{\der \Gamma, x : T}
    \qquad
    \ru{\der \Gamma
      }{\Gamma \der \Type_i : \Type_{i+1}}
    \qquad
    \ru{\der \Gamma \qquad
        (x : T) \in \Gamma
      }{\Gamma \der x : T}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : \Pi x:A.B \qquad
        \Gamma \der t' : A
      }{\Gamma \der t\ t' : B[t'/x]}
    \qquad
    \ru{\Gamma \der A : s \qquad
        \Gamma, x:A \der B : s' \qquad
        (s,s',s'') \in \R
      }{\Gamma \der \Pi x:A.B : s''}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der \Pi x:A.B : s \qquad
        \Gamma, x:A \der t : B
      }{\Gamma \der \lambda x:A.t : \Pi x:A.B}
    \qquad
    \ru{\Gamma \der T : s \qquad
        \Gamma \der t,t' : T
      }{\Gamma \der \Id T\ t\ t' : s}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : T
      }{\Gamma \der \refl_t : \Id T\ t\ t}
    \qquad
    \tru{\Gamma \der A : s \qquad
         \Gamma \der C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
       }{\Gamma \der b : \Pi x:A. C\ x\ x\ \refl_x
       }{\Gamma \der u, v : A \qquad
         \Gamma \der p : \Id A\ u\ v
       }{\Gamma \der \J (A,C,b,u,v,p) : C\ u\ v\ p}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der t : A \qquad
        \Gamma \der B : s \qquad
        \Gamma \der A \le B
      }{\Gamma \der t : B}
  \)
  \end{center}

  \noindent %
  Now, we consider our rules for squash (acting as a resizing rule!).
  Elimination requires that $B$ is not a sort in a positive way:
  $B \nequiv s$ shall stand for
  $B ::\equiv \Pi \_ \mid \Id \_ \mid \squash{\_}$.

  \begin{center}
  \(
    \ru{\Gamma \der A : \Type_i
      }{\Gamma \der \squash{A} : \Type_0}
    \qquad
    \ru{\Gamma \der t : A
      }{\Gamma \der [t] : \squash{A}}
    \qquad
    \ru{\Gamma \der T : s \qquad
        \Gamma \der u,v : \squash{T}
      }{\Gamma \der \seq(T,u,v) : \Id \squash{T}\ u\ v}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{\Gamma \der f : A \to B \qquad
        \Gamma \der h : \Pi_{x:A} \Pi_{y:A} \Id A\ x\ y \qquad
        \Gamma \der a : \squash{A} \qquad
        B \nequiv s
      }{\Gamma \der \elim(A,B,f,h,a) : B}
  \)
  \end{center}

  \section{Equality Rules}

  \paradot{Computation ($\beta$) and extensionality ($\eta$)}

  \begin{mathc}
    \ru{\Gamma, x:U \der t:V \qquad
        \Gamma \der u : U
      }{\Gamma \der (\lambda x:U.t)~u = t[u/x] : V[u/x]}
    \qquad
    \ru{\Gamma \der t : \Pi x:U.V
      }{\Gamma \der t = \lambda x:U.t~x : \Pi x:U.V}
  \end{mathc}

  \begin{mathc}
    \dru{\Gamma \der A : s \qquad
         \Gamma \der C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
       }{\Gamma \der b : \Pi x:A. C\ x\ x\ \refl_x \qquad
         \Gamma \der u : A
       }{\Gamma \der \J (A,C,b,u,u,\refl_u) = b\ u : C\ u\ u\ \refl_u}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \der f : A \to B \qquad
        \Gamma \der h : \Pi_{x:A} \Pi_{y:A} \Id A\ x\ y \qquad
        \Gamma \der t : A \qquad
        B \nequiv s
      }{\Gamma \der \elim(A,B,f,h,[t]) = f\ t : B}
  \end{mathc}

  \paradot{Equivalence Rules}

  \begin{mathc}
    \ru{\Gamma \der t : T
      }{\Gamma \der t = t : T}
    \qquad
    \ru{\Gamma \der t' = t : T
      }{\Gamma \der t = t' : T}
    \qquad
    \ru{\Gamma \der t_1 = t_2 : T \qquad
        \Gamma \der t_2 = t_3 : T
      }{\Gamma \der t_1 = t_3 : T}
  \end{mathc}

  \paradot{Compatibility Rules}

  \begin{mathc}
    \rux{\Gamma \der U = U' : s \qquad
         \Gamma, x:U \der V = V' : s'
       }{\Gamma \der \Pi x:U.V = \Pi x:U'.V' : s''
       }{(s,s',s'')}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \der U = U' : s \qquad
        \Gamma, x:U \der V : s' \qquad
        \Gamma, x:U \der t = t' : V
      }{\Gamma \der \lambda x:U.t = \lambda x:U'.t' : \Pi x:U.V}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \der t = t' : \Pi x:U.V \qquad
        \Gamma \der u = u' : U
      }{\Gamma \der t~u = t'~u' : V[u/x]}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \der T = T' : s \qquad
        \Gamma \der t = t' : T \qquad
        \Gamma \der u = u' : T
      }{\Gamma \der \Id T\ t\ u = \Id T'\ t'\ u' : s}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \der t = t' : T \qquad
      }{\Gamma \der \refl_t = \refl_{t'} : \Id T\ t\ t}
  \end{mathc}

  \begin{mathc}
    \tru{\Gamma \der A = A' : s \qquad
         \Gamma \der C = C' : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
       }{\Gamma \der b = b' : \Pi x:A. C\ x\ x\ \refl_x
       }{\Gamma \der u = u' : A \qquad
         \Gamma \der v = v' : A \qquad
         \Gamma \der p = p' : \Id A\ u\ v
       }{\Gamma \der \J (A,C,b,u,v,p) = \J (A',C',b',u',v',p') : C\ u\ v\ p}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \der A = A' : s
      }{\Gamma \der \squash{A} = \squash{A'} : \Type_0}
    \qquad
    \ru{\Gamma \der T = T' : s \qquad
        \Gamma \der t = t' : \squash{T} \qquad
        \Gamma \der u = u' : \squash{T}
      }{\Gamma \der \seq(T,t,u) = \seq(T',t',u') : \Id \squash{T}\ t\ u}
  \end{mathc}

  \begin{mathc}
    \dru{\Gamma \der A = A' : s \qquad
         \Gamma \der B = B' : s' \qquad
         B \nequiv s
       }{\Gamma \der f = f' : A \to B \qquad
         \Gamma \der h, h' : \Pi_{x:A} \Pi_{y:A} \Id A\ x\ y \qquad
         \Gamma \der a, a' : \squash{A}
       }{\Gamma \der \elim(A,B,f,h,a) = \elim(A,B,f,h,a) : B}
  \end{mathc}

  \paradot{Conversion Rule}

  \begin{mathc}
    \ru{\Gamma \der t = t' : T \quad
        \Gamma \der T \le T'
      }{\Gamma \der t = t' : T'}
  \end{mathc}

  \section{Cumulativity}

  \begin{mathc}
    \rux{}{\Gamma \der \Type_i \le \Type_j}{i \le j}
    \qquad
    \ru{\Gamma \der U = U' : s \qquad
        \Gamma, x:U \der T \le T'
      }{\Gamma \der \Pi x:U.T \le \Pi x:U'.T'}
  \end{mathc}

  \begin{mathc}
    \ru{\Gamma \der T = T' : s
      }{\Gamma \der T \le T'}
    \qquad
    \ru{\Gamma \der T_1 \le T_2 \qquad
        \Gamma \der T_2 \le T_3
      }{\Gamma \der T_1 \le T_3}
  \end{mathc}

  \section{Consistency}

  While, initially, the Kripke logical relation we're going to define was
  created to prove soundness of algorithmic equality, we will mainly focus
  on consistency. We might handle decidability later.

  \paradot{Weak head normalization}

  Weak head normal forms (whnfs) are given by the following grammar:

  \begin{align*}
    \Whnf &\ni a,f,A,B,F &::=~& \Pi x:U.T \mid \Id T\ t\ u \mid \squash{T} \\
        &&\mid~& n \mid \lambda x:U.t \mid \refl_t \mid [t] \mid \seq(T,t,u) \\
    \Wne  &\ni n,N &::=~& x \mid n~u \mid \elim(T,U,t,u,n) \mid \J (T,U,b,u,v,n)
  \end{align*}
  %
  We present weak-head reduction as follows:

  \begin{center}
  \(
    \ru{t \rew f \qquad
        f~u \rew a
      }{t~u \rew a}
    \qquad
    \ru{}{a \rew a}
    \qquad
    \ru{t[u/x] \rew a
      }{(\lambda x:U.t)~u \rew a}
    \qquad
    \ru{}{n~u \rew n~u}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{p \rew \refl_t \qquad
        u \rew a \qquad
        v \rew a \qquad
        t \rew a \qquad
        b\ u \rew a'
      }{\J (T,U,b,u,v,p) \rew a'}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{p \rew n
      }{\J (T,U,b,u,v,p) \rew \J (T,U,b,u,v,n)}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{v \rew [v'] \qquad
        t\ v' \rew a
      }{\elim(T,U,t,u,v) \rew a}
    \qquad
    \ru{v \rew n
      }{\elim(T,U,t,u,v) \rew \elim(T,U,t,u,n)}
  \)
  \end{center}
  %
  We will write $\red t$ for $a$ when $t \rew a$.

  \paradot{An Induction Measure}

  In order to define the logical relation, we define semantic universe
  hierarchy.
  By recursion on $i \in \mathbb{N}$, we define
  $\U_i \in \Whnf \times \mathcal{P}(\Whnf)$ as follows.

  \begin{center}
  \(
    \ru{}{(N, \Wne) \in \U_i}
    \qquad
    \rux{}{(\Type_i, \mid \U_i \mid) \in \U_j}{(\Type_i,\Type_j)}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{(U, \mathcal{A}) \in \widehat{U_i} \qquad
         \forall u \in \widehat{\mathcal{A}}.\ (T[u/x],\mathcal{F}(u)) \in
         \widehat{\U_j}
       }{(\Pi x:U.T, \Pi \mathcal{A} \mathcal{F}) \in \U_k
       }{(\Type_i, \Type_j, \Type_k)}
  \)
  \end{center}

  \begin{center}
  \(
    \ru{(T,\mathcal{A}) \in \U_i
      }{(\Id T\ u\ v, \oeq\ \mathcal{A}\ u\ v) \in \U_i}
    \qquad
    \ru{}{(\squash{A}, \Squash) \in \U_i}
  \)
  \end{center}

  \noindent %
  Here, $\mathcal{A}$ denotes sets of expressions, $\mathcal{F}$ functions from
  expressions to set of expressions while
  $\widehat{\U_i} = \{ (T,\mathcal{A}) \mid (\red T, \mathcal{A}) \in \U_i \}$
  and $\mid \U_i \mid = \{ A \mid (A, \mathcal{A}) \in \U_i \text{ for some }
  \mathcal{A} \}$.
  $\widehat{\mathcal{A}} = \{ t \mid \red t \in \mathcal{A} \}$ is the closure
  of $\mathcal{A}$ by weak head expansion.
  The dependent function space is defined as
  $\Pi \mathcal{A} \mathcal{F} = \{ f \in \Whnf \mid \forall u \in
  \widehat{\mathcal{A}},\ f~u \in \widehat{\mathcal{F}(u)} \}$.
  The equality space is defined as
  $\oeq\ \mathcal{A}\ u\ v = \Wne \bigcup \{ \refl_t \mid t \in
  \widehat{\mathcal{A}} \}$.
  Finally, the squash space is just
  $\Squash = \Wne \bigcup \{ [t] \mid \red t \in \Whnf \}$.

  \paradot{Transports}

  In order to define the logical relation, we first need to define some
  transports that will make sure everything is well-typed. We indeed need to
  since our logical relation doesn't only capture conversion but all provable
  equalities.

  \[\transport : \Pi A\ A' : \Type.(\Id \Type\ A\ A') \to A \to A'\]
  \[\transport A\ A'\ p\ x := \J(\Type, (\lambda T\ T'\ eq. T \to T'),
  (\lambda T\ x. x), A, A', p)\ x\]
  %
  We will write $p_*$ for $\transport A\ A'\ p$.

  \[\ap : \Pi A\ B : \Type. \Pi (f : A \to B). \Pi (u\ v : A).
    (\Id u\ v) \to (\Id (f\ u)\ (f\ v))\]
  \[\ap A\ B\ f\ u\ v\ p := \J(A, (\lambda x\ y\ p. \Id (f\ x)\ (f\ y)),
  (\lambda x. \refl_{f\ x}), u, v, p)\]
  %
  We will write $\ap f : \Id x\ y \to \Id (f\ x)\ (f\ y)$ with the other
  arguments understood.

  \[\sym : \Pi A : \Type. \Pi x\ y : A. (\Id x\ y) \to (\Id y\ x)\]
  \[\sym A\ x\ y\ p := \J(A, (\lambda u\ v\ e. \Id v\ u), (\lambda u. \refl_u),
  x,y,p)\]
  %
  We will write $p\inv$ for $\sym A\ x\ y\ p$.

  \[\trans : \Pi A : \Type. \Pi x\ y\ z : A.
  (\Id x\ y) \to (\Id y\ z) \to (\Id x\ z)\]
  \[
    \trans A\ x\ y\ z\ p := \J(A, (\lambda u\ v\ e. \Id v\ z \to \Id u\ z),
    (\lambda u\ e. e), x, y, p)
  \]
  %
  We will write $p \cons q$ for $\trans A\ x\ y\ z\ p\ q$.

  \[
    \transdom : \Pi (A\ A' : \Type)\ (p : \Id A\ A')\ (B' : A' \to \Type).
                (A \to \Type)
  \]
  \[
    \transdom p\ B'\ a := B'\ (p_* a)
  \]
  As in the definition, we will omit $A$ and $A'$.

  \[
  \begin{array}{l@{\quad}l}
    \transfun :~& \Pi (A\ A' : \Type)\ (B : A \to \Type)\ (B' : A' \to \Type) \\
                & (p : \Id A\ A').\ \Id B\ (\transdom p\ B') \to \\
                & \Id (\Pi (x:A).B) (\Pi (x:A').B') \\
    \transfun :=& ...
  \end{array}
  \]
  It is done in agda, let's not write it.
  We will write $\pi\ p\ q$ for $\transfun A\ A'\ B\ B'\ p\ q$.
  We will admit we have a similar $\id\ p\ q\ r$ for identity types and
  $\squash{p}$ for squashes.

  \[
  \begin{array}{l@{\quad}l}
    \app :~& \Pi (A : \Type)\ (B : A \to \Type)\ (f\ f' : \Pi x:A.B) \\
           & (u\ u' : A)\ (p : \Id f\ f')\ (q : \Id u\ u') \to \\
           & \Id (f\ u)\ (((\ap (\lambda x.B)\ (q\inv))_* (f'\ u')))
  \end{array}
  \]

  \paradot{A Kripke Logical Relation}

  By induction on $A \in s$, we define two Kripke relations:
  \begin{center}
  \(
    \Gamma \der \hideq{p} A \Er A' : s
    \qquad
    \Gamma \der \hideq{p} a \Er a' : A
  \)
  \end{center}
  together with their respective closures $\hEr$.
  We define them in rule form for better readability meaning we have to see the
  conclusion to be defined as the conjunction of the premises.

  \begin{mathc}
    \ru{\Gamma \der e : \Id A\ a\ a' \qquad
        A \nequiv s, \Pi \_
      }{\Gamma \der \hideq{e} a \Er a' : A}
    \qquad
    \ru{\Gamma \der \hideq{p} \red t \Er \red t' : \red T
      }{\Gamma \der \hideq{p} t \hEr t' : T}
  \end{mathc}

  \begin{mathc}
    \tru{\Gamma \der e : \Id (\Pi x:U.T)\ f\ f'
       }{\forall \Delta \le \Gamma, \Delta \der \hideq{p} u \hEr u' : U \gives
         \Delta \der u = u' : U \gives
       }{\Delta \der \hideq{\app e\ p} f\ u \hEr
         (\ap (\lambda x.T)\ p\inv)_* (f'\ u') : T[u/x]
       }{\Gamma \der \hideq{e} f \Er f' : \Pi x:U.T}
  \end{mathc}

  \begin{center}
  \(
    \ru{\Gamma \der e : \Id s\ N\ N'
      }{\Gamma \der \hideq{e} N \Er N' : s}
    \qquad
    \ru{\Gamma \der e : \Id s''\ s\ s'
      }{\Gamma \der \hideq{e} s \Er s' : s''}
    \qquad
    \ru{\Gamma \der e : \Id s\ T\ T'
      }{\Gamma \der \hideq{\squash{e}} \squash{T} \Er \squash{T'} : s'}
  \)
  \end{center}

  \begin{center}
  \(
    \rux{\Gamma \der \hideq{p} U \hEr U' : s \qquad
          \Gamma, x:U \der \hideq{q} V \hEr V'[p_*\ x / x] : s'
        }{\Gamma \der \hideq{\pi\ p\ q} \Pi x:U.V \Er \Pi x:U'.V' : s''
        }{(s,s',s'')}
  \)
  \end{center}

  \begin{mathc}
    \ru{\Gamma \der \hideq{p} T \hEr T' : s \qquad
        \Gamma \der \hideq{q} u \hEr (p\inv)_*\ u' : T \qquad
        \Gamma \der \hideq{r} v \hEr (p\inv)_*\ v' : T
      }{\Gamma \der \hideq{\id\ p\ q\ r} \Id T\ u\ v \Er \Id T'\ u'\ v' : s}
  \end{mathc}

  \begin{lemma}[Weakening]
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der \hideq{p} a \Er a' : A$ and $\Delta \le \Gamma$ then
      there exists a derivation of $\Delta \der \hideq{p} a \Er a' : A$ with the
      same height.
      \item Analogously for $\Gamma \der \hideq{p} t \hEr t' : T$.
    \end{itemize}
  \end{lemma}
  %
  \begin{proof}
    By induction on $A \in s$ and $T \in s$.
  \end{proof}

  \begin{lemma}[Type Conversion]
    \label{lem:s-conv}
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der \hideq{p} A \Er A' : s$ and
      $\Gamma \der \hideq{q} a \Er a' : A$ then
      $\Gamma \der \hideq{\ap p_*\ q} p_*\ a \Er p_*\ a' : A'$.
      \item If $\Gamma \der \hideq{p} T \hEr T' : s$ and
      $\Gamma \der \hideq{q} t \hEr t : T$ then
      $\Gamma \der \hideq{\ap p_*\ q} p_*\ t \Er p_*\ t' : T'$.
    \end{itemize}
    And in both cases, we have to converse using $p\inv$.
  \end{lemma}

  \begin{proof}
    Simultaneously by induction on $A \in s$ and $T \in s$.
    We only show the ``if'' direction.

    We show the case of functions, all the others are similar.
    \meta{TODO: Update with new definition}

    \begin{caselist}
      \nextcase
      \begin{mathc}
        \rux{\Gamma \der \hideq{p} U \hEr U' : s \qquad
              \Gamma, x:U \der \hideq{q} V \hEr V'[p_*\ x / x] : s'
            }{\Gamma \der \hideq{\pi\ p\ q} \Pi x:U.V \Er \Pi x:U'.V' : s''
            }{(s,s',s'')}
      \end{mathc}
      \begin{mathc}
        \ru{\Gamma \der e : \Id (\Pi x:U.V)\ f\ f'
          }{\Gamma \der \hideq{e} f \Er f' : \Pi x:U.V}
      \end{mathc}
      Using $\ap (\pi\ p\ q)_*\ e$ we have the solution directly.
    \end{caselist}
  \end{proof}

  \begin{lemma}[Symmetry and Transitivity]
    \label{lem:s-per}
    Let $\Gamma \der \hideq{p} T \hEr T : s$.
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der \hideq{q} t \hEr t' : T$ then
      $\Gamma \der \hideq{q\inv} t' \hEr t : T$.
      \item If $\Gamma \der \hideq{q_1} t_1 \hEr t_2 : T$ and
      $\Gamma \der \hideq{q_2} t_2 \hEr t_3 : T$
      then $\Gamma \der \hideq{q_1 \cons q_2} t_1 \hEr t_3 : T$.
    \end{itemize}
  \end{lemma}

  \begin{proof}
    We generalize the two statements to whnfs
    $\Gamma \der \hideq{p} A \Er A : s$ and
    prove all four statements simultaneously by induction.

    \begin{center}
    \(
      \ru{\Gamma \der p : \Id s\ T\ T
        }{\Gamma \der \hideq{\squash{p}} \squash{T} \Er \squash{T} : s'}
    \)
    \end{center}

    \begin{caselist}
      \nextcase Symmetry.
      \begin{mathc}
        \ru{\Gamma \der e : \Id \squash{T}\ f\ f'
          }{\Gamma \der \hideq{e} f \Er f' : \squash{T}}
      \end{mathc}
      Symmetry holds directly with $e\inv$.

      \nextcase Transitivity also holds immediately with $e_1 \cons e_2$.
    \end{caselist}
  \end{proof}

  \begin{lemma}[Into the logical relation]
    Let $T \in s$.
    If $\Gamma \der e : \Id T\ n\ n'$ then $\Gamma \der n \hEr n' : T$.
  \end{lemma}

  \begin{proof}
    This holds directly by definition of $\hEr$.
  \end{proof}

  \paradot{Validity in the Model}

  We define an equality judgement for substitutions by induction on the
  destination context (it captures that they are convertible in particular,
  which means that any judgement is stable under the application of
  ``equal'' substitutions).
  %
  \begin{center}
  \(
    \ru{}{\Delta \der \sigma \hEr \sigma' : \cdot}
    \qquad
    \ru{\Delta \der \sigma \hEr \sigma' : \Gamma \qquad
        \Delta \der \sigma(x) \hEr \sigma'(x) : U \sigma \qquad
        \Delta \der \sigma(x) = \sigma'(x) : U \sigma
      }{\Delta \der \sigma \hEr \sigma' : \Gamma, x:U}
  \)
  \end{center}

  We then define the context ($\Der \Gamma$), type ($\Gamma \Der T = T'$) and
  term ($\Gamma \Der t = t' : T$) validity relations by induction on the length
  of contexts.

  \begin{mathc}
    \ru{}{\Der \cdot}
    \qquad
    \ru{\Der \Gamma \qquad
        \Gamma \Der U
      }{\Der \Gamma, x:U}
    \qquad
    \ru{\Gamma \Der T = T' : s
      }{\Gamma \Der T = T'}
    \qquad
    \ru{\Gamma \Der T = T
      }{\Gamma \Der T}
  \end{mathc}

  \begin{mathc}
    \dru{\Der \Gamma \qquad
         (\Gamma \Der T \text{ unless } T = s)
       }{\forall \Delta, \sigma, \sigma',\ %
         \Delta \der \sigma \hEr \sigma' : \Gamma \gives
         \Delta \der t \sigma \hEr t' \sigma' : T \sigma
       }{\Gamma \Der t = t' : T}
    \qquad
    \ru{\Gamma \Der t = t : T
      }{\Gamma \Der t : T}
  \end{mathc}

  \begin{lemma}[Substitution relation is a PER]
    \label{lem:subst-rel-per}
    The relation $\Delta \der \_ \hEr \_ : \Gamma$ for substitutions
    is symmetric and transitive.
  \end{lemma}

  \begin{proof}
    It is implied by transitivity and symmetry for terms (for $\hEr$ and the
    definitional equality).
  \end{proof}

  \begin{lemma}[Validity is a PER]
    The relation $\Gamma \Der \_ = \_ : T$ is symmetric and transitive.
  \end{lemma}

  \begin{proof}
    \leavevmode
    \begin{caselist}
      \nextcase Symmetry.\\
      Assume $\Gamma \Der t = t' : T$ and show $\Gamma \Der t' = t : T$.
      Now assume $\Delta \der \sigma \hEr \sigma' : \Gamma$ and show
      $\Gamma \der t' \sigma \hEr t \sigma' : T \sigma$ (the other goals are
      already assumed). This holds because of lemma~\ref{lem:s-per} by
      instantiating the hypothesis with $\sigma'$, $\sigma$ (that are in
      relation by lemma~\ref{lem:subst-rel-per}).

      \nextcase Transitivity.\\
      Assume $\Gamma \Der t_1 = t_2 : T$ and $\Gamma \Der t_2 = t_3 : T$ and
      show $\Gamma \Der t_1 = t_3 : T$.
      Now assume $\Delta \der \sigma \hEr \sigma' : \Gamma$ and show
      $\Gamma \der t_1 \sigma \hEr t_3 \sigma' : T \sigma$.
      We instantiate the hypotheses with $\sigma,\sigma$ and $\sigma,\sigma'$
      and conclude by transitivity of $\hEr$ (lemma~\ref{lem:s-per}).
    \end{caselist}
  \end{proof}

  \begin{lemma}[Function type injectivity is valid]
    \label{lem:fun-inj-valid}
    If $\Gamma \Der U \to T = U' \to T'$ then $\Gamma \Der U = U'$ and
    $\Gamma, x:U \Der T = T'$.
  \end{lemma}

  \begin{proof}
    Assume arbitrary $\Delta \der \sigma \hEr \sigma' : \Gamma$.
    We have
    $\Delta \der U \sigma \to T\sigma \hEr U'\sigma' \to T' \sigma' : s_3$
    for some $s_3$. Thus, by definition,
    $\Delta \der \hideq{p} U \sigma \hEr U' \sigma' : s_1$ for some $s_1$ and
    $p$. So, $\Gamma \Der U = U'$.

    We also have
    $\Delta, x:U\sigma \der T \sigma \hEr T'\sigma' : s_2$ for some $s_2$
    (as $T'$ doesn't depend on $x$).
    Thus, for any $\rho$ that extends $\sigma$ on $x$ (and $\rho'$ being the
    same extension but for $\sigma'$), we have the result,
    enough to conclude $\Gamma, x:U \Der T = T'$.
  \end{proof}

  \begin{lemma}[Context Satisfiable]
    If $\Der \Gamma$ then $\der \Gamma$ and $\Gamma \der \id \hEr \id : \Gamma$.
  \end{lemma}

  \begin{proof}
    By induction on $\Gamma$.
  \end{proof}

  \paradot{Fundamental Theorem}
  We prove a series of lemmata which constitute parts of the fundamental theorem
  for the Kripke logical relation.

  Although, we state them with $\Gamma \Der \mathcal{J}$ as hypothesis,
  it is only to explicit the induction hypothesis we have from
  $\Gamma \der \mathcal{J}$, thus any hypothesis consisting of a conversion
  is preserved (because we use the same substitution on both sides),
  meaning the expressions are still well-typed.

  \begin{lemma}[Validity of $\beta$-reduction]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma, x:U \Der t : T \qquad
          \Gamma \Der u : U
        }{\Gamma \Der (\lambda x:U.t)\ u = t[u/x] : T[u/x]}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    $\Der \Gamma$ is contained in $\Gamma \Der u : U$.
    Now, given $\Delta \der \rho \hEr \rho' : \Gamma$, we need to show
    $\Delta \der (\lambda x:U.t)\rho\ u\rho \hEr (t[u/x])\rho' : (T[u/x])\rho'$
    and $\Delta \der (T[u/x])\rho \hEr (T[u/x])\rho' : s$ for some $s$
    (to get $\Gamma \Der T[u/x]$)

    Let $\sigma = (\rho, u \rho/x)$ and $\sigma' = (\rho', u \rho'/x)$.
    So $\Delta \der \sigma \hEr \sigma' : \Gamma, x:U$ (by instantiation of the
    second hypothesis, and noticing that $\Gamma \der u\rho = u\rho' : U\rho$).
    Thus, $\Delta \der t \sigma \hEr t' \sigma' : T\sigma$
    \ie $\Delta \der (t[u/x])\rho \hEr (t[u/x])\rho' : (T[u/x])\rho$
    which is weak-head convertible to our first goal.
    The first hypothesis, instantiated with $\sigma$,$\sigma'$ also gives
    $\Gamma \Der T[u/x]$.
  \end{proof}

  \begin{lemma}[Validity of $\eta$]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der t : \Pi x:U.T
        }{\Gamma \Der t = \lambda x:U.t\ x : \Pi x:U.T}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    Assume arbitrary $\Delta \der \sigma \hEr \sigma' : \Gamma$ and show
    $\Delta \der t \sigma \hEr \lambda x:U\sigma'. t\sigma'\ x :
    \Pi x:U\sigma.T\sigma$.
    The equality is proved by $\refl$, now assume $\Delta' \le \Delta$
    and $\Delta' \der \hideq{p} u \hEr u' : U\sigma$
    and $\Delta' \der u = u' : U \sigma$
    and show
    $\Delta' \der \hideq{\app \refl\ p} t\sigma\ u \hEr
    (\ap (\lambda x.T\sigma)\ p\inv)_* ((\lambda x:U\sigma'. t\sigma'\ x)\ u') :
    \Pi x:U\sigma.T\sigma$.

    This reduces to proving
    $\Delta' \der \hideq{\app \refl\ p} t\sigma\ u \hEr
    (\ap (\lambda x.T\sigma)\ p\inv)_* (t \sigma'\ u') :
    \Pi x:U\sigma.T\sigma$ which corresponds to an instantiation of
    the hypothesis.
  \end{proof}

  \begin{lemma}[Validity of $\lambda$ equality]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der U = U' : s \qquad
          \Gamma, x:U \Der V : s' \qquad
          \Gamma, x:U \Der t = t' : V
        }{\Gamma \Der \lambda x:U.t = \lambda x:U'.t' : \Pi x:U.V}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    Assume $\Delta \der \sigma \hEr \sigma' : \Gamma$ and show
    $\Delta \der \lambda x:U\sigma.t\sigma = \lambda x:U'\sigma'.t'\sigma' :
    \Pi x:U\sigma.V\sigma$.
    The basic equality is $\refl$.

    Now assume $\Delta' \le \Delta$ and
    $\Delta' \der \hideq{p} u \hEr u' : U\sigma$ and
    $\Delta' \der u = u' : U \sigma$
    and show $\Delta' \der \hideq{\app \refl\ p}
    (\lambda x:U\sigma.t\sigma)\ u \hEr
    (\ap (\lambda x.V\sigma)\ p\inv)_* ((\lambda x:U'\sigma'.t'\sigma')\ u') :
    \Pi x:U\sigma.V\sigma$ which reduces to proving
    $\Delta' \der \hideq{\app \refl\ p}
    (t\sigma)[u/x] \hEr (\ap (\lambda x.V\sigma)\ p\inv)_* ((t'\sigma')[u'/x]) :
    \Pi x:U\sigma.V\sigma$.

    Let $\rho = (\sigma, u\sigma / x)$ and $\rho' = (\sigma', u'\sigma' / x)$.
    Thus, $\Delta' \der \rho \hEr \rho' : \Gamma, x:U$.
    We can then instantiate our third hypothesis to conclude.
  \end{proof}

  \begin{lemma}[Validity of $\elim$ reduction]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der f : U \to T \qquad
          \Gamma \Der h : \Pi_{x:T} \Pi_{y:T} \Id T\ x\ y \qquad
          \Gamma \Der t : U \qquad
          T \nequiv s
        }{\Gamma \Der \elim(U,T,f,h,[t]) = f\ t : T}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    $\Der \Gamma$ is contained in any of the hypothesese.
    $\Gamma \Der T$ is implied by $\Gamma \Der f : U \to T$ and
    lemma~\ref{lem:fun-inj-valid}.
    %
    Now assume $\Delta, \sigma, \sigma'$ such that
    $\Delta \der \sigma \hEr \sigma' : \Gamma$ and
    show (for some $p$)
    \[\Delta \der \hideq{p}
    \elim(U \sigma,T \sigma,f \sigma,h \sigma,[t \sigma]) \hEr
    f \sigma'\ t \sigma' : T \sigma.\]
    This reduces (by weak-head conversion) to showing
    $\Delta \der \hideq{p}
    f \sigma\ t \sigma \hEr
    f \sigma'\ t \sigma' : T \sigma$.
    This is done by reflexivity, knowing that $T \sigma$ is not a sort
    and that the substitutions are indeed convertible.
  \end{proof}

  \begin{lemma}[Validity of $\elim$ equality]
    \leavevmode
    \begin{mathc}
      \dru{\Gamma \Der U = U' \qquad
           \Gamma \Der T = T' \qquad
           T, T' \nequiv s
         }{\Gamma \Der f = f' : U \to T \qquad
           \Gamma \Der h, h' : \Pi_{x:T} \Pi_{y:T} \Id T\ x\ y \qquad
           \Gamma \Der t,t' : \squash{U}
         }{\Gamma \Der \elim(U,T,f,h,t) = \elim(U',T',f',h',t') : T}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    $\Der \Gamma$ is contained in any of the hypotheses.
    $\Gamma \Der T$ follows from $\Gamma \Der T = T'$ and the fact that validity
    is a PER.
    Now assume $\Delta, \sigma, \sigma'$ such that
    $\Delta \der \sigma \hEr \sigma' : \Gamma$ and
    show
    \[\Delta \der \elim(U \sigma,T \sigma,f \sigma,h \sigma,t \sigma) \hEr
    \elim(U' \sigma',T' \sigma',f' \sigma',h' \sigma',t' \sigma') : T \sigma.\]
    %
    We look at $a$ and $a'$ the whnfs of $t \sigma$ and $t' \sigma'$.
    We have three possible cases (by symmetry):
    \begin{caselist}
      \nextcase $a \equiv [u]$ and $a' \equiv [u']$.
      Thus, our goal becomes
      $\Delta \der f \sigma\ u \hEr f' \sigma'\ u' : T \sigma$.
      Since $T \nequiv s$ is stated positively, $T \sigma$ is not a
      sort. So we only need a proof of equality which is deduced from $h$.

      \nextcase $a \equiv n$ and $a' \equiv [u']$.
      For similar reasons, this holds (we can still instantiate $h$ on the
      whnfs).

      \nextcase $a \equiv n$ and $a' \equiv n'$.
      Likewise.
    \end{caselist}
  \end{proof}

  \begin{lemma}[Validity of application]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der t = t' : \Pi x:U.V \qquad
          \Gamma \Der u = u' : U
        }{\Gamma \Der t~u = t'~u' : V[u/x]}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    \meta{Check $\Gamma \Der V[u/x]$.}
    Assume arbitrary $\Delta \der \sigma : \Gamma$ and show
    $\Delta \der t\sigma\ u\sigma \hEr t'\sigma\ u'\sigma : (V[u/x])\sigma$.
    If $(V[u/x])\sigma$ is not a sort, it works directly.
    Otherwise, \meta{We can't conclude it would seem...}
  \end{proof}

  \begin{lemma}[Validity of $\J$ equality]
    \leavevmode
    \begin{mathc}
      \tru{\Gamma \Der A = A' : s \qquad
           \Gamma \Der C = C' : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
         }{\Gamma \Der b = b' : \Pi x:A. C\ x\ x\ \refl_x
         }{\Gamma \Der u = u' : A \qquad
           \Gamma \Der v = v' : A \qquad
           \Gamma \Der p = p' : \Id A\ u\ v
         }{\Gamma \Der \J (A,C,b,u,v,p) = \J (A',C',b',u',v',p') : C\ u\ v\ p}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    $\Der \Gamma$ holds, as well as
    $\Gamma \Der C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'$,
    so does $\Gamma \Der C\ u\ v\ p : s'$ (it follows from the fact that
    $C\ u\ v\ p$ is well-typed and obviously has the same as itself).

    Now assume arbitrary $\Delta \der \sigma : \Gamma$ and show
    \[\Delta \der \J(A \sigma, C \sigma, b \sigma, u \sigma, v \sigma, p \sigma)
    \hEr \J(A' \sigma, C' \sigma, b' \sigma, u' \sigma, v' \sigma, p' \sigma) :
    C \sigma\ u \sigma\ v \sigma\ p \sigma.\]
    %
    We look at the normal forms (respectively $a$ and $a'$) of $p \sigma$ and
    $p' \sigma$:
    \begin{caselist}
      \nextcase $a \equiv \refl$ and $a' \equiv \refl$.
      In which case we have to show
      $\Delta \der b \sigma\ u\sigma \hEr b'\sigma\ u'\sigma :
      C \sigma\ u \sigma\ u \sigma\ \refl$.
      \meta{I need the ability to instantiate when the instantiated $C$ is a
      sort.}

      \nextcase $a \equiv \refl$ and $a' \equiv \seq(B,u'',v'')$.
      \meta{Perhaps we should treat it in the case of neutrals...}

      \nextcase $a \equiv \seq(B,t,w)$ and $a' \equiv \seq(B',t',w')$.
      \meta{TODO}

      \nextcase $a \equiv \refl$ and $a' \equiv n'$.
      \meta{TODO}

      \nextcase $a \equiv \seq(B,t,w)$ and $a' \equiv n'$.
      \meta{TODO}

      \nextcase $a \equiv n$ and $a' \equiv n'$.
      \meta{TODO}
    \end{caselist}
  \end{proof}

  \begin{lemma}[Validity of $\J$ reduction]
    \leavevmode
    \begin{mathc}
      \dru{\Gamma \Der A : s \qquad
           \Gamma \Der C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'
         }{\Gamma \Der b : \Pi x:A. C\ x\ x\ \refl_x \qquad
           \Gamma \Der u : A
         }{\Gamma \Der \J (A,C,b,u,u,\refl_u) = b\ u : C\ u\ u\ \refl_u}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    Assume arbitrary $\Delta \der \sigma : \Gamma$ and show
    $\Delta \der \J (A\sigma,C\sigma,b\sigma,u\sigma,u\sigma,\refl_{u\sigma})
    \hEr b\sigma\ u\sigma : C\sigma\ u\sigma\ u\sigma\ \refl_{u\sigma}$.
    This reduces to showing
    $\Delta \der b\sigma\ u\sigma
    \hEr b\sigma\ u\sigma : C\sigma\ u\sigma\ u\sigma\ \refl_{u\sigma}$
    which holds in any case.
  \end{proof}

  \begin{lemma}[Validity of conversion]
    \leavevmode
    \begin{mathc}
      \ru{\Gamma \Der t = t' : T \quad
          \Gamma \Der T \le T'
        }{\Gamma \Der t = t' : T'}
    \end{mathc}
  \end{lemma}

  \begin{proof}
    This follows from lemma~\ref{lem:s-conv} where we transport along $\refl$
    (which is the identity).
  \end{proof}

  \begin{theorem}[Fundamental theorem of logical relations]
    \leavevmode
    \begin{itemize}
      \item If $\der \Gamma$ then $\Der \Gamma$.
      \item If $\Gamma \der t : T$ then $\Gamma \Der t : T$.
      \item If $\Gamma \der t = t' : T$ then $\Gamma \Der t = t' : T$.
    \end{itemize}
  \end{theorem}

  \begin{proof}
    By induction on the derivation.
    All the compatibility rules with a type $T \nequiv s$ are handled by
    $\refl$, compatibility for types is also direct.
    Equivalence rules are also direct (by lemma~\ref{lem:s-per} and by
    definition of typing validity as the diagonal).
    Typing validity also follows easily.
  \end{proof}

  \begin{corollary}[Syntactic validity]
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der t : T$ then $\Gamma \der T$.
      \item If $\Gamma \der t = t' : T$ then $\Gamma \der t : T$ and
      $\Gamma \der t' : T$.
    \end{itemize}
  \end{corollary}
  Alright.

  \section{Meta-Theoretic Consequences of the Model Construction}

  \paradot{Inversion}

  \begin{lemma}[Inversion]
    \label{lem:inversion}
    \leavevmode
    \begin{itemize}
      \item If $\Gamma \der x : T$ then $(x:U) \in \Gamma$ for some
      $U$ with $\Gamma \der U \le T$.
      \item If $\Gamma \der \lambda x:U.t : T$ then $\Gamma, x:U \der t : T'$
      for some $T'$ with $\Gamma \der \Pi x:U.T' \le T$.
      \item If $\Gamma \der t\ u : T$ then $\Gamma \der t : \Pi x:U.T'$
      for some $U$ and $T'$ with $\Gamma \der T'[u/x] \le T$.
      \item If $s : T$ then there is $s'$ such that $(s,s') \in \Ax$
      and $\Gamma \der s' = T$.
      \item If $\Gamma \der \Pi x:U.T' : T$ then $\Gamma \der U : s$
      and $\Gamma, x:U \der T : s'$ and for some $s''$ we have
      $\Gamma \der s'' = T$ and $(s,s',s'') \in \R$.
      \item If $\Gamma \der \refl_t : T$ then $\Gamma \der t : U$
      for some $U$ with $\Gamma \der \Id U\ t\ t = T$.
      \item If $\Gamma \der \J(A,C,b,u,v,p) : T$ then $\Gamma \der A : s$
      and $\Gamma \der C : \Pi x:A. \Pi y:A. (\Id A\ x\ y) \to s'$ and
      $\Gamma \der b : \Pi x:A. C\ x\ x\ \refl_x$ and $\Gamma \der u, v : A$
      and $\Gamma \der p : \Id A\ u\ v$ for some $s,s'$ with
      $\Gamma \der C\ u\ v\ p \le T$.
      \item If $\Gamma \der \Id T'\ t\ t' : T$ then $\Gamma \der t,t' : T'$
      and $\Gamma \der s = T$ for some $s$.
      \item If $\Gamma \der [t] : T$ then $\Gamma \der t : T'$ for some
      $T'$ with $\Gamma \der \squash{T'} = T$.
      \item If $\Gamma \der \elim(A,B,f,h,a) : T$ then
      $\Gamma \der f : A \to B$ and
      $\Gamma \der h : \Pi_{x:A} \Pi_{y:A} \Id A\ x\ y$
      and $\Gamma \der a : \squash{A}$ and $\Gamma \der B \le T$.
      \item If $\Gamma \der \seq(T',u,v) : T$ then $\Gamma \der T' : s$ for
      some $s$ and $\Gamma \der u, v : \squash{T'}$ and
      $\Gamma \der T = \Id \squash{T'}\ u\ v$.
      \item If $\Gamma \der \squash{T'} : T$ then $\Gamma \der T' : s$ for
      some $s$ and $\Gamma \der s' = T'$ for some $s'$.
    \end{itemize}
  \end{lemma}

  \begin{proof}
    By induction on the typing derivation.
  \end{proof}

  \paradot{Normalization and subject reduction}

  We assume our system to be normalizing with the subject reduction property.

  \paradot{Consistency}

  Importantly, not every type is inhabited, thus, it can be used as a logic.
  A prerequisite is that types can be distinguished, which follows immediately
  from the construction of the logical relation.

  \begin{lemma}[Type constructor discrimination]
    \label{lem:cons-discr}
    Neutral types, sorts, $\Pi$-types, identity types and
    squash types are mutually unequal.
    \leavevmode
    \begin{itemize}
      \item $\Gamma \der N \neq s$.
      \item $\Gamma \der N \neq \Pi x:U.T$.
      \item $\Gamma \der N \neq \Id T\ u\ v$.
      \item $\Gamma \der N \neq \squash{T}$.
      \item $\Gamma \der s = s'$ implies $\Id s\ s'$ is inhabited in $\Gamma$.
      \item $\Gamma \der s \neq \Pi x:U.T$.
      \item $\Gamma \der s \neq \Id T\ u\ v$.
      \item $\Gamma \der s \neq \squash{T}$.
      \item $\Gamma \der \Pi x:U.T \neq \Id T'\ u\ v$.
      \item $\Gamma \der \Pi x:U.T \neq \squash{T'}$.
      \item $\Gamma \der \Id T\ u\ v \neq \squash{T'}$.
    \end{itemize}
  \end{lemma}

  \begin{proof}
    By the fundamental theorem applied to the identity substitution.
    For instance, assume $\Gamma \der N = s$, by fundamental theorem,
    $\Gamma \Der N = s$, so, $\Gamma \der \hideq{p} N \Er s$, since this is
    comparision of types, there is no rule to derive it, hence the
    contradiction.
  \end{proof}

  \begin{theorem}[Consistency]
    $X : \Type_0 \nvdash t : X$.
  \end{theorem}

  \begin{proof}
    Let $\Gamma = (X : \Type_0)$.
    Assuming $\Gamma \der t : X$, we have $\Gamma \der a : X$ for $a$ the whnf
    of $t$. We invert on the typing of $a$.
    By lemma~\ref{lem:cons-discr}, $X$ cannot be equal (or in a subtype
    relation since it preserves the shape) to a sort, a $\Pi$-type,
    an indentity type or a squash type.
    Thus, $a$ can neither be a $\lambda$, nor a $\refl$,
    nor a $[\_]$ nor a $\Pi$-type, an indentity type or
    a squash type, nor a sort, it can only be neutral.

    $X$ being the only variable, it is the only reason for the term to be
    blocked.
    Since $X$ is not of $\Pi$-type, it cannot be applied.
    Since $X$ is not of identity type, it cannot be eliminated with $\J$.
    Since $X$ is not of squash type, it cannot be eliminated through $\elim$.
    So $a \equiv X$ and then $\Gamma \der X : X$, implying
    $\Gamma \der \Type_0 \le X$ by inversion
    (lemma~\ref{lem:inversion}), meaning $\Gamma \der \Type_i = X$ for some
    $i$ which is in contradiction with lemma~\ref{lem:cons-discr}.
  \end{proof}

\end{document}
